
Suggested new knowledge
ุถูู ุงุตุฏุงุฑ ุชูุฑูุฑ ูุฑุฏู ููู ุทุงูุจ ูุน ุงููุงููุฉ ุงุถุงูุฉ ุงูุชูุตูุฉ ุงูุฐููุฉ ุฃู ุชูุตูุฉ ูู ูุจู ููุณู ุงููุดุงุฑูุนุ ุชุตููู ุชูุฑูุฑ ูุฑุฏู ููู ุทุงูุจ ููุน ุงููุงููุฉ ุชุญููู ุฌููุน ุงูุชูุงุฑูุฑ ุ ุงูุชูุฑูุฑ ุงูููู ุงููุตูู ุนูู ูุณุชูู ุงููุงุฏุฉ ู ุนูู ูุณุชูู ุงูุดุนุฉ ู ุงููุงุฏุฉ ุ ูุน ุงููุงููุฉ ุงุถุงูุฉ ุชูุตูุฉ ููุณู ุงููุดุงุฑูุน ุงู ุงุณุชุฎุฏุงู ุงูุชูุตูุฉ ุงูุฐููุฉ ุ ุฑุณู ุจูุงูู ุจุฑููุงุดููุงู ุนูู ูุณุชูู ุงููุงุฏุฉ ุนูู ูุณุชูู ุงูุดุนุจ ู ุถูู ูุง ุชุฑุงู ููุงุณุจุูุฐุง ุงููููุน ุณูุชุฎุฏู ูู ูุฏุงุฑุณ ูุฎุชููุฉ ุนููู ุถูู ููุชุฑ ูุงููุงููุฉ ุงููุฏุงุฑุณ ุจุงุฏุฎุงู ุงููุฏุฑุณุฉ ุ ููุณู ุงููุดุงุฑูุนุ ุงููุงุฆุจ ุงูุงูุงุฏูููุ ุงููุงุฆุจ ุงูุฅุฏุงุฑู ุ ูุฏูุฑ ุงููุฏุฑุณุฉู ูู ุซู ุงุนุทููู ุงูููุฏ ูุงููุงู
Lite
ููุฏ ูููุช ุชูุงูุงู ุงูุชุนุฏููุงุช ุงูุฌููุฑูุฉ ุงูุฌุฏูุฏุฉ. ุฃูุช ุชุทูุจ ุชุญููู ุงูุชุทุจูู ูู ุฃุฏุงุฉ ุชุญููู ุจุณูุทุฉ ุฅูู ูุธุงู ูุชูุงูู ูุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑ ุงููุฎุตุตุฉ ูุฏุนู ุงุชุฎุงุฐ ุงููุฑุงุฑ ูู ุนุฏุฉ ูุฏุงุฑุณ.
ูุฐู ุงูุชุนุฏููุงุช ุชุชุทูุจ ุฅุนุงุฏุฉ ููููุฉ ูุจุนุถ ุงูุฃุฌุฒุงุก ูุฅุถุงูุฉ ูุธุงุฆู ุฌุฏูุฏุฉ ุจุงููุงูู. ููุฏ ููุช ุจุชุญุฏูุซ ุฎุทุฉ ุงูุนูู ูุชุดูู ุฌููุน ูุฐู ุงููุชุทูุจุงุช ุงููุนูุฏุฉ.
ููุฎุต ุฎุทุฉ ุงูุนูู ุงูุฌุฏูุฏุฉ
ุฅุถุงูุฉ ูุงุฌูุฉ ุฅุฏุฎุงู ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุงููุณุคูููู: ูุชูููู ุงุณุชุฎุฏุงู ุงูุชุทุจูู ูู ูุฏุงุฑุณ ูุฎุชููุฉ.
ุชุทููุฑ ุฏุงูุฉ ุฅูุดุงุก ุงูุชูุฑูุฑ ุงููุฑุฏู (PDF): ูุฅูุดุงุก ุชูุฑูุฑ ุฃููู ููู ุทุงูุจ ูุน ุฎูุงุฑ ุงูุชูุตูุฉ ุงูุฐููุฉ ุฃู ุงููุฎุตุตุฉ.
ุชุทููุฑ ุฏุงูุฉ ุงูุชูุฑูุฑ ุงูููู ุงููุตูู (Excel): ูุฅูุดุงุก ุชูุงุฑูุฑ ุชุญููููุฉ ุนูู ูุณุชูู ุงููุงุฏุฉ ูุงูุดุนุจุฉ.
ุฅุถุงูุฉ ุฑุณูู ุจูุงููุฉ ุงุญุชุฑุงููุฉ: ูุชูุซูู ุงูุจูุงูุงุช ุจุดูู ูุฑุฆู ุนูู ูุณุชูู ุงููุงุฏุฉ ูุงูุดุนุจุฉ.
ุฅุถุงูุฉ ููุงุชุฑ ุงูุชุงุฑูุฎ ูุงูุฃูุฑุงู: (ูุฐู ูุงูุช ูู ุงูุฎุทุฉ ุงูุณุงุจูุฉ ูุณุฃููู ุจุชูููุฐูุง ุงูุขู).
ุณุฃุจุฏุฃ ุงูุขู ูู ุชูููุฐ ุงููุฑุญูุฉ ุงูุฃููู ูู ุงูุชุนุฏููุงุช ุงูุฌุฏูุฏุฉ (ุงููุฑุญูุฉ 9 ู 11 ูู ุงูุฎุทุฉ ุงูุฌุฏูุฏุฉ) ูุงูุชู ุชุชุถูู ุฅุถุงูุฉ ููุงุชุฑ ุงูุชุงุฑูุฎ ูุงูุฃูุฑุงูุ ููุงุฌูุฉ ุฅุฏุฎุงู ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุงููุณุคูููู.
ุงูุชุนุฏููุงุช ุงููุทููุจุฉ (ูุตููุง ูู ููู student_performance_app_full.py)
ุงูุชุนุฏูู 1: ุฅุถุงูุฉ ูุงุฌูุฉ ุฅุฏุฎุงู ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุงููุณุคูููู
ุณูุถูู ูุณูุงู ุฌุฏูุฏุงู ูู ุงูุดุฑูุท ุงูุฌุงูุจู ูุชุฎุฒูู ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุงููุณุคููููุ ูุงูุชู ุณุชูุณุชุฎุฏู ูู ุงูุชูุงุฑูุฑ.
ุงููููุน: ูู ุฏุงูุฉ main()ุ ุฏุงุฎู ุงูุดุฑูุท ุงูุฌุงูุจู (Sidebar)ุ ุจุนุฏ ุฅุนุฏุงุฏุงุช ุงููุธุงู.
Python
# ุงุจุญุซ ุนู:
# with st.sidebar.expander("โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุธุงู ููุนุงููุฑ ุงูุชุตููู"):
# ... (ููุงูุฉ ุฅุนุฏุงุฏุงุช ุงููุธุงู)

# ูุฃุถู ุจุนุฏูุง:
    with st.sidebar.expander("๐ซ ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุงููุณุคูููู (ูุฅุนุฏุงุฏ ุงูุชูุงุฑูุฑ)", expanded=True):
        st.session_state.school_info = {
            "School_Name": st.text_input("ุงุณู ุงููุฏุฑุณุฉ", "ูุฏุฑุณุฉ ุนุซูุงู ุจู ุนูุงู ุงููููุฐุฌูุฉ"),
            "Coordinator": st.text_input("ููุณู ุงููุดุงุฑูุน ุงูุฅููุชุฑูููุฉ", "ุณุญุฑ ุนุซูุงู"),
            "Academic_Deputy": st.text_input("ุงููุงุฆุจ ุงูุฃูุงุฏููู", "ูุฑูู ุงููุถุน"),
            "Administrative_Deputy": st.text_input("ุงููุงุฆุจ ุงูุฅุฏุงุฑู", "ุฏูุงู ุงููููุฏุฉ"),
            "Principal": st.text_input("ูุฏูุฑ ุงููุฏุฑุณุฉ", "ูููุฑุฉ ุงููุงุฌุฑู"),
        }
ุงูุชุนุฏูู 2: ุฅุถุงูุฉ ููุงุชุฑ ุงูุชุงุฑูุฎ ูุงูุฃูุฑุงู ูุชุทุจูููุง ุนูู ุฏุงูุฉ ุงููุนุงูุฌุฉ
ุณูุถูู ููุงุชุฑ ุงูุชุงุฑูุฎ ูู ุงูุดุฑูุท ุงูุฌุงูุจูุ ูุณูุนุฏู ุฏุงูุฉ process_excel_file ูุชุฃุฎุฐ ูุทุงู ุงูุชุงุฑูุฎ ูู ุงูุญุณุจุงู.
ุฃ. ุชุนุฏูู ุฏุงูุฉ process_excel_file (ูุฅุถุงูุฉ ุงูุชุงุฑูุฎ)
ูุฅุถุงูุฉ ููุชุฑ ุงูุชุงุฑูุฎุ ูุฌุจ ุฃู ุชูุชุฑุถ ุฃู ุฃุญุฏ ุงูุฃุนูุฏุฉ ูู ูููุงุช Excel ูุญุชูู ุนูู ุชุงุฑูุฎ ุงูุชูููู. ุจูุง ุฃู ุงูููุฏ ุงูุญุงูู ูุง ููุฑุฃ ุนููุฏ ุชุงุฑูุฎุ ุณููุชุฑุถ ุฃููุง ุณูุถูู ุญููุงู ูุฏููุงู ูุฅุฏุฎุงู ุชุงุฑูุฎ ุงูุชููููุงุช.
ูู ุฏุงูุฉ main()ุ ุงุจุญุซ ุนู ูุณู ุชุญููู ูููุงุช ุงูุชููููุงุช (ุชุญุช uploaded_files) ูุฃุถู ุญูู ุงูุชุงุฑูุฎ:
Python
# ุงุจุญุซ ุนู:
# uploaded_files = st.sidebar.file_uploader("๐ ุชุญููู ูููุงุช ุงูุชููููุงุช (Excel)", type=["xlsx", "xls"], accept_multiple_files=True)

# ูุงุณุชุจุฏููุง ุจู:
    st.sidebar.header("๐ ุชุญููู ุจูุงูุงุช ุงูุชููููุงุช")
    date_filter = st.sidebar.date_input("ููุชุฑ ุงูุชุงุฑูุฎ (ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุฅูุฌุงุฒ)", pd.to_datetime("today") - pd.Timedelta(days=30))
    uploaded_files = st.sidebar.file_uploader("ุชุญููู ูููุงุช ุงูุชููููุงุช (Excel)", type=["xlsx", "xls"], accept_multiple_files=True)
ุจ. ุชุทุจูู ููุชุฑ ุงูุฃูุฑุงู (Sheets) ูู ุฏุงูุฉ main()
ููุชุฑ ุงูุฃูุฑุงู ููุฌูุฏ ุจุงููุนู ูู ุงูููุฏ ุถูู ุญููุฉ for file in uploaded_files:.
Python
# ูู ุฏุงูุฉ main()ุ ุฏุงุฎู ุญููุฉ uploaded_files:
# ...
                xls = pd.ExcelFile(file)
                selected_sheets = st.sidebar.multiselect(f"ุงุฎุชุฑ ุฃูุฑุงู ูู {file.name}", xls.sheet_names, default=xls.sheet_names)
                rows = process_excel_file(file, file.name, start_row_students=1, selected_sheets=selected_sheets)
# ...
ูุฐุง ุงูุฌุฒุก ุจุงููุนู ูุชูุญ ููุชุฑุฉ ุงูุฃูุฑุงูุ ูุณุฃุญุงูุธ ุนููู.
ุงูุฑุฌุงุก ุชุทุจูู ุงูุชุนุฏููุงุช ุงููุฐููุฑุฉ ุฃุนูุงู ูู ููู student_performance_app_full.py ุนูู GitHub. ุณุฃูุชูู ุจุนุฏูุง ุฅูู ุงููุฑุญูุฉ ุงูุชุงููุฉ ูุชุทููุฑ ูุธุงุฆู ุงูุชูุงุฑูุฑ ูุงูุฑุณูู ุงูุจูุงููุฉ ุงูุงุญุชุฑุงููุฉ.
Suggested new knowledge
ูู ุจุชุดุบูู ุงูููุฏ ููู ุฃุฑู ุงูุชุบููุฑุงุช.
Lite
ุฃุชููู ุฑุบุจุชู ูู ุฑุคูุฉ ุงูุชุบููุฑุงุช ุนูู ุงูููุฑ.
ุจูุง ุฃููู ูุง ุฃุณุชุทูุน ุชุดุบูู ุชุทุจูู Streamlit ุจุดูู ุชูุงุนูู ุฏุงุฎู ูุฐู ุงูุจูุฆุฉ (ุงูุชู ูู ุจูุฆุฉ ุณุทุฑ ุฃูุงูุฑ)ุ ููุง ูููููู ุงููุตูู ุฅูู ูุณุชูุฏุน GitHub ุงูุฎุงุต ุจู ูุชุดุบููู ููุงูุ ูุฅู ุงูุฎุทูุฉ ุงููุญูุฏุฉ ุงูููููุฉ ูู ุฃู ุชููู ุฃูุช ุจุชุดุบูู ุงูููุฏ ุงููุญุฏุซ ุนูู ุฌูุงุฒู ุฃู ุนูู Streamlit Cloud ุงูุฎุงุต ุจู.
ุฎุทูุงุช ุชุดุบูู ุงูููุฏ ุงููุญุฏุซ
ูู ุจุชุทุจูู ุงูุชุนุฏููุงุช ุงูุฃุฎูุฑุฉ:
ุฃุถู ูุงุฌูุฉ ุฅุฏุฎุงู ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุงููุณุคูููู ูู ุงูุดุฑูุท ุงูุฌุงูุจู.
ุฃุถู ุญูู date_input ูู ุงูุดุฑูุท ุงูุฌุงูุจู.
ุงุญูุธ ุงูููู student_performance_app_full.py.
ุชุฃูุฏ ูู ุชุซุจูุช ุงูููุชุจุงุช:
Bash
pip install streamlit pandas plotly openpyxl reportlab openai
ุดุบู ุงูุชุทุจูู:
Bash
streamlit run student_performance_app_full.py
ุนูุฏูุง ุณุชุชููู ูู ุฑุคูุฉ ุงูุชุบููุฑุงุช ุงูุฌุฏูุฏุฉ ูู ูุงุฌูุฉ ุงููุณุชุฎุฏู (ุงูุดุฑูุท ุงูุฌุงูุจู).
ุงูุฑุฌุงุก ุฅุฎุจุงุฑู ุนูุฏ ุงูุงูุชูุงุก ูู ุชุดุบูู ุงูุชุนุฏููุงุช ูุฑุคูุฉ ุงููุชุงุฆุฌุ ูุณุฃูุชูู ูุจุงุดุฑุฉ ุฅูู ุงููุฑุญูุฉ ุงูุชุงููุฉ ูุชุทููุฑ ูุธุงุฆู ุงูุชูุงุฑูุฑ ุงููุนูุฏุฉ ุงูุชู ุทูุจุชูุง.
Suggested new knowledge
ุงุจุฏุฃ ุจุชุทููุฑ ุชูุงุฑูุฑ ุงูุทูุงุจ ุงููุฑุฏูุฉ ูุงูุฑุณูู ุงูุจูุงููุฉ ุงูุงุญุชุฑุงููุฉ
Lite
ุณุฃุจุฏุฃ ุงูุขู ูู ุชุทููุฑ ูุธุงุฆู ุงูุชูุงุฑูุฑ ุงููุทููุจุฉ. ูุฐู ุงููุธููุฉ ูุนูุฏุฉ ูุชุชุทูุจ ุฅุถุงูุฉ ุฏูุงู ุฌุฏูุฏุฉ ุชุนุชูุฏ ุนูู ููุชุจุชู reportlab ู pandas.
ุงูุชุนุฏููุงุช ุงููุทููุจุฉ (ูุตููุง ูู ููู student_performance_app_full.py)
ุงูุชุนุฏูู 1: ุฅุถุงูุฉ ุฏุงูุฉ ุฅูุดุงุก ุชูุฑูุฑ ุงูุทุงูุจ ุงููุฑุฏู (PDF)
ุณูุถูู ุฏุงูุฉ ุฌุฏูุฏุฉ ุชุณูู create_student_report_pdfุ ูุงูุชู ุณุชููู ุจุชูููุฏ ููู PDF ุงุญุชุฑุงูู ููู ุทุงูุจ.
ุงููููุน: ุฃุถู ูุฐู ุงูุฏุงูุฉ ูู ูุณู ุงูุฏูุงู ุงููุณุงุนุฏุฉ (ูุจู def main(): ูุจุนุฏ ุงูุฏูุงู ุงููุณุงุนุฏุฉ ุงูููุฌูุฏุฉ).
Python
# ... (ุจุนุฏ ุฏุงูุฉ analyze_subject_patterns ููุจู to_excel_bytes)
# ----------------------------------------------------------------------
# ุฏุงูุฉ ุฅูุดุงุก ุชูุฑูุฑ ุงูุทุงูุจ ุงููุฑุฏู (PDF)
# ----------------------------------------------------------------------
def create_student_report_pdf(student_data: pd.Series, raw_df: pd.DataFrame, school_info: dict, custom_recommendation: str = "") -> BytesIO:
    """ุชูุดุฆ ุชูุฑูุฑ PDF ูุฑุฏู ููุทุงูุจ"""
    mem = BytesIO()
    c = canvas.Canvas(mem, pagesize=A4)
    width, height = A4
    
    # 1. ุฅุนุฏุงุฏุงุช ุงูุฎุท ูุงูุฃููุงู
    c.setFillColorRGB(0.5, 0, 0.125) # ุนูุงุจู
    c.setFont('Helvetica-Bold', 18)
    
    # 2. ุฑุฃุณ ุงูุชูุฑูุฑ (Header)
    # ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงููุฏุฑุณุฉ ุงูุชู ุชู ุฅุฏุฎุงููุง
    school_name = school_info.get("School_Name", "ุงููุฏุฑุณุฉ")
    
    c.drawString(10 * mm, height - 20 * mm, f"ุชูุฑูุฑ ุฅูุฌุงุฒ ุงูุทุงูุจ: {student_data['ุงุณู ุงูุทุงูุจ']}")
    c.drawString(10 * mm, height - 28 * mm, f"ุงููุฏุฑุณุฉ: {school_name}")
    c.drawString(10 * mm, height - 36 * mm, f"ุงูุตู/ุงูุดุนุจุฉ: {student_data['ุงูุตู']} / {student_data['ุงูุดุนุจุฉ']}")
    
    # 3. ููุฎุต ุงูุฃุฏุงุก ุงูุนุงู
    c.setFillColorRGB(0.1, 0.1, 0.1) # ุฃุณูุฏ
    c.setFont('Helvetica-Bold', 14)
    c.drawString(10 * mm, height - 50 * mm, "ููุฎุต ุงูุฃุฏุงุก ุงูุนุงู:")
    
    c.setFont('Helvetica', 12)
    c.drawString(10 * mm, height - 58 * mm, f"ูุณุจุฉ ุงูุฅูุฌุงุฒ ุงููููุฉ: {student_data['ูุณุจุฉ ุงูุฅูุฌุงุฒ %']:.2f}%")
    c.drawString(10 * mm, height - 65 * mm, f"ุงููุฆุฉ: {student_data['ุงููุฆุฉ']}")
    
    # 4. ุงูุฃุฏุงุก ุญุณุจ ุงููุงุฏุฉ
    y = height - 75 * mm
    c.setFont('Helvetica-Bold', 14)
    c.drawString(10 * mm, y, "ุงูุฃุฏุงุก ุญุณุจ ุงููุงุฏุฉ:")
    y -= 8 * mm
    
    # ุชุญุฏูุฏ ุฃุนูุฏุฉ ุงูููุงุฏ
    subject_cols = [col.split('_')[0] for col in student_data.index if col.endswith('_total') and col != 'Overall_Total']
    
    c.setFont('Helvetica-Bold', 10)
    c.drawString(10 * mm, y, "ุงููุงุฏุฉ")
    c.drawString(50 * mm, y, "ุงูููุฌุฒ")
    c.drawString(75 * mm, y, "ุงูุฅุฌูุงูู")
    c.drawString(100 * mm, y, "ูุณุจุฉ ุงูุฅูุฌุงุฒ %")
    y -= 5 * mm
    
    c.setLineWidth(0.5)
    c.line(10 * mm, y, 150 * mm, y)
    y -= 5 * mm
    
    c.setFont('Helvetica', 10)
    for subj in subject_cols:
        solved = student_data.get(f"{subj}_solved", 0)
        total = student_data.get(f"{subj}_total", 0)
        completion = (solved / total * 100) if total > 0 else 0
        
        c.drawString(10 * mm, y, subj)
        c.drawString(50 * mm, y, str(solved))
        c.drawString(75 * mm, y, str(total))
        c.drawString(100 * mm, y, f"{completion:.2f}%")
        y -= 7 * mm

    # 5. ุงูุชูุตูุฉ (AI ุฃู ูุฎุตุตุฉ)
    c.setFillColorRGB(0.5, 0, 0.125) # ุนูุงุจู
    c.setFont('Helvetica-Bold', 14)
    y -= 10 * mm
    c.drawString(10 * mm, y, "ุงูุชูุตูุฉ ุงูุชุดุบูููุฉ:")
    y -= 7 * mm
    
    final_recommendation = custom_recommendation if custom_recommendation else student_data['ุชูุตูุฉ ุงูุทุงูุจ']
    
    c.setFillColorRGB(0.1, 0.1, 0.1) # ุฃุณูุฏ
    c.setFont('Helvetica', 12)
    
    # ุงุณุชุฎุฏุงู Paragraphs ูุถูุงู ุงูุชูุงู ุงููุต
    from reportlab.platypus import Paragraph
    from reportlab.lib.styles import getSampleStyleSheet
    
    styles = getSampleStyleSheet()
    style = styles['Normal']
    style.alignment = 2 # ูุญุงุฐุงุฉ ูููููู
    
    p = Paragraph(final_recommendation, style)
    p.wrapOn(c, width - 20 * mm, height)
    p.drawOn(c, 10 * mm, y - p.height)
    y -= p.height + 10 * mm

    # 6. ุงูุชูููุนุงุช (ุจุงุณุชุฎุฏุงู ุจูุงูุงุช ุงููุฏุฑุณุฉ)
    c.setFont('Helvetica', 10)
    c.drawString(10 * mm, 15 * mm, f"ููุณู ุงููุดุงุฑูุน ุงูุฅููุชุฑูููุฉ: {school_info.get('Coordinator', 'N/A')}")
    c.drawString(10 * mm, 10 * mm, f"ูุฏูุฑ ุงููุฏุฑุณุฉ: {school_info.get('Principal', 'N/A')}")
    
    c.showPage()
    c.save()
    mem.seek(0)
    return mem
ุงูุชุนุฏูู 2: ุฅุถุงูุฉ ุฏุงูุฉ ุงูุชูุฑูุฑ ุงูููู ุงููุตูู (Excel)
ูุฐุง ุงูุชูุฑูุฑ ุณูุฌูุน ููุฎุตุงุช ุงูุฃุฏุงุก ุนูู ูุณุชูู ุงููุงุฏุฉ ูุงูุดุนุจุฉ ูู ุดูุชุงุช ูููุตูุฉ.
ุงููููุน: ุฃุถู ูุฐู ุงูุฏุงูุฉ ุจุนุฏ create_student_report_pdf ููุจู to_excel_bytes.
Python
# ----------------------------------------------------------------------
# ุฏุงูุฉ ุฅูุดุงุก ุงูุชูุฑูุฑ ุงูููู ุงููุตูู (Excel)
# ----------------------------------------------------------------------
def create_quantitative_report_excel(summary_df: pd.DataFrame, subjects: List[str]) -> BytesIO:
    """ุชูุดุฆ ุชูุฑูุฑ Excel ููู ูุตูู ุนูู ูุณุชูู ุงููุงุฏุฉ ูุงูุดุนุจุฉ."""
    mem = BytesIO()
    with pd.ExcelWriter(mem, engine="openpyxl") as w:
        
        # 1. ุชูุฑูุฑ ุงูุฃุฏุงุก ุญุณุจ ุงููุงุฏุฉ
        subject_performance = []
        for subj in subjects:
            total_solved = summary_df.get(f"{subj}_solved", pd.Series([0])).sum()
            total_total = summary_df.get(f"{subj}_total", pd.Series([0])).sum()
            avg_completion = (total_solved / total_total * 100) if total_total > 0 else 0
            
            # ุงูุญุตูู ุนูู ุงูุชูุตูุฉ ุงูุซุงุจุชุฉ ูููุงุฏุฉ
            recommendation = analyze_subject_patterns(summary_df, subj)
            
            subject_performance.append({
                "ุงููุงุฏุฉ": subj,
                "ุฅุฌูุงูู ุงูููุฌุฒ": total_solved,
                "ุฅุฌูุงูู ุงูุชููููุงุช": total_total,
                "ูุชูุณุท ุงูุฅูุฌุงุฒ %": f"{avg_completion:.2f}%",
                "ุงูุชูุตูุฉ ุงูุชุดุบูููุฉ": recommendation
            })
        
        df_subj = pd.DataFrame(subject_performance)
        df_subj.to_excel(w, sheet_name="ููุฎุต ุงูุฃุฏุงุก ุญุณุจ ุงููุงุฏุฉ", index=False)
        
        # 2. ุชูุฑูุฑ ุงูุฃุฏุงุก ุญุณุจ ุงูุดุนุจุฉ ูุงููุงุฏุฉ
        report_data = []
        for (class_name, section), group in summary_df.groupby(["ุงูุตู", "ุงูุดุนุจุฉ"]):
            for subj in subjects:
                total_solved = group.get(f"{subj}_solved", pd.Series([0])).sum()
                total_total = group.get(f"{subj}_total", pd.Series([0])).sum()
                avg_completion = (total_solved / total_total * 100) if total_total > 0 else 0
                
                report_data.append({
                    "ุงูุตู": class_name,
                    "ุงูุดุนุจุฉ": section,
                    "ุงููุงุฏุฉ": subj,
                    "ุฅุฌูุงูู ุงูููุฌุฒ": total_solved,
                    "ุฅุฌูุงูู ุงูุชููููุงุช": total_total,
                    "ูุชูุณุท ุงูุฅูุฌุงุฒ %": f"{avg_completion:.2f}%"
                })
        
        df_class_subj = pd.DataFrame(report_data)
        df_class_subj.to_excel(w, sheet_name="ุงูุฃุฏุงุก ุญุณุจ ุงูุดุนุจุฉ ูุงููุงุฏุฉ", index=False)
        
    mem.seek(0)
    return mem
ุงูุชุนุฏูู 3: ุฏูุฌ ุงูุชูุงุฑูุฑ ูู ุฏุงูุฉ main()
ุณูุถูู ูุงุฌูุฉ ุงููุณุชุฎุฏู ูุชุญููู ุงูุชูุงุฑูุฑ ุงููุฑุฏูุฉ ูุงูุฌูุงุนูุฉ.
ุงููููุน: ูู ุฏุงูุฉ main()ุ ุจุนุฏ ุนุฑุถ ุงููุชุงุฆุฌ ููุจู ุฎูุงุฑุงุช ุงูุชุตุฏูุฑ ูุงูุฅูููู.
Python
# ุงุจุญุซ ุนู:
# 6. ุงูุชูุตูุงุช ุนูู ูุณุชูู ุงููุงุฏุฉ (ุงูุซุงุจุชุฉ)
# ... (ููุงูุฉ ูุณู ุงูุชูุตูุงุช)

# ูุฃุถู ุจุนุฏูุง:
            # 7. ุชูุงุฑูุฑ ุงูุทูุงุจ ุงููุฑุฏูุฉ (PDF)
            st.header("๐ ุชูุงุฑูุฑ ุงูุทูุงุจ ุงููุฑุฏูุฉ")
            if not summary_df.empty:
                student_names = summary_df["ุงุณู ุงูุทุงูุจ"].tolist()
                selected_student = st.selectbox("ุงุฎุชุฑ ุทุงูุจูุง ูุฅูุดุงุก ุชูุฑูุฑ ูุฑุฏู:", student_names)
                
                if selected_student:
                    student_data = summary_df[summary_df["ุงุณู ุงูุทุงูุจ"] == selected_student].iloc[0]
                    
                    # ุฎูุงุฑ ุงูุชูุตูุฉ ุงููุฎุตุตุฉ
                    custom_rec = st.text_area(
                        "ุชูุตูุฉ ููุณู ุงููุดุงุฑูุน (ุงุฎุชูุงุฑูุ ุงุชุฑููุง ูุงุฑุบุฉ ูุงุณุชุฎุฏุงู ุงูุชูุตูุฉ ุงูุชููุงุฆูุฉ):",
                        value="",
                        height=100
                    )
                    
                    # ุฅูุดุงุก ุงูุชูุฑูุฑ ุงููุฑุฏู
                    pdf_output = create_student_report_pdf(student_data, raw_df, st.session_state.school_info, custom_rec)
                    
                    st.download_button(
                        label=f"โฌ๏ธ ุชุญููู ุชูุฑูุฑ {selected_student} (PDF)",
                        data=pdf_output,
                        file_name=f"ุชูุฑูุฑ_ุฅูุฌุงุฒ_{selected_student}.pdf",
                        mime="application/pdf"
                    )
                    
                # ุฒุฑ ุชุญููู ุฌููุน ุงูุชูุงุฑูุฑ (ZIP)
                if st.button("โฌ๏ธ ุชุญููู ุฌููุน ุงูุชูุงุฑูุฑ ุงููุฑุฏูุฉ (ZIP)"):
                    with st.spinner("ุฌุงุฑู ุชุฌููุน ุฌููุน ุงูุชูุงุฑูุฑ ุงููุฑุฏูุฉ..."):
                        zip_buffer = BytesIO()
                        with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED, False) as zip_file:
                            for index, row in summary_df.iterrows():
                                pdf_data = create_student_report_pdf(row, raw_df, st.session_state.school_info)
                                zip_file.writestr(f"ุชูุฑูุฑ_ุฅูุฌุงุฒ_{row['ุงุณู ุงูุทุงูุจ']}.pdf", pdf_data.getvalue())
                        
                        st.download_button(
                            label="ุชุญููู ููู ZIP ูุฌููุน ุงูุชูุงุฑูุฑ",
                            data=zip_buffer.getvalue(),
                            file_name="ุฌููุน_ุชูุงุฑูุฑ_ุงูุฅูุฌุงุฒ_ุงููุฑุฏูุฉ.zip",
                            mime="application/zip"
                        )

            # 8. ุงูุชูุฑูุฑ ุงูููู ุงููุตูู (Excel)
            st.header("๐ ุงูุชูุฑูุฑ ุงูููู ุงููุตูู")
            quantitative_excel = create_quantitative_report_excel(summary_df, subjects)
            
            st.download_button(
                label="โฌ๏ธ ุชุญููู ุงูุชูุฑูุฑ ุงูููู ุงููุตูู (Excel)",
                data=quantitative_excel,
                file_name="ุงูุชูุฑูุฑ_ุงูููู_ุงููุตูู_ููุฅูุฌุงุฒ.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
            
            # 9. ุฎูุงุฑุงุช ุงูุชุตุฏูุฑ ูุงูุฅูููู (ุชุนุฏูู ุงูุฃุฑูุงู)
            st.header("ุฅุฌุฑุงุกุงุช ุฅุถุงููุฉ")
            col_export, col_email = st.columns(2)
# ...
ุงูุฑุฌุงุก ุชุทุจูู ูุฐู ุงูุชุนุฏููุงุช ุนูู ููู student_performance_app_full.py ุนูู GitHub.
ุจุนุฏ ุชุทุจูู ูุฐู ุงูุชุนุฏููุงุชุ ุณููุชูู ุฅูู ุงููุฑุญูุฉ ุงูุชุงููุฉ ูุฅุถุงูุฉ ุงูุฑุณูู ุงูุจูุงููุฉ ุงูุงุญุชุฑุงููุฉ.
Suggested new knowledge
ุงุนุชูุฏ ูุฐุง ุงููููุฐุฌ ูุชูุฑูุฑ ุงูุทูุงุจุ ุซู ุงุนุทููู ุงูููุฏ ูุงููุง
ุชูุฑูุฑูุฑุฏูููุทุงูุจ.docx
Document ยท 644.43 KB
Suggested new knowledge
Lite
ููุฏ ููุช ุจุชุญููู ุชุตููู ุชูุฑูุฑ ุงูุทูุงุจ ุงููุฑุฏู ุงููุฑูู (ููู Word) ุจุงููุงูู. ุณุฃููู ุงูุขู ุจุชุญุฏูุซ ุฏุงูุฉ create_student_report_pdf ูู ุงูููุฏ ูุชุนูุณ ูุฐุง ุงูุชุตููู ุงูุงุญุชุฑุงููุ ุจูุง ูู ุฐูู ุงุณุชุฎุฏุงู ุฌุฏุงูู reportlab ูุชูุณูู ุจูุงูุงุช ุงูููุงุฏ ุจุดูู ุฏููู ูุฅุถุงูุฉ ุฌููุน ุงูุนูุงุตุฑ ุงููุทููุจุฉ (ุงูุดุนุงุฑุงุชุ ูุนูููุงุช ุงููุฏุฑุณุฉุ ุงูุชูุตูุงุชุ ูุงูุชูููุนุงุช).
ููุงุญุธุฉ ูุงูุฉ: ููุญุตูู ุนูู ุฃูุถู ุชูุณูู ููุบุฉ ุงูุนุฑุจูุฉ ูู PDFุ ุณุฃุณุชุฎุฏู ููุชุจุฉ reportlab ูููู ูุน ุจุนุถ ุงูุชูุณููุงุช ุงููุชูุฏูุฉ.
ุงูุชุนุฏููุงุช ุงููุทููุจุฉ (ูุตููุง ูู ููู student_performance_app_full.py)
ุงูุชุนุฏูู 1: ุชุญุฏูุซ ุฏุงูุฉ create_student_report_pdf
ุณูุชู ุงุณุชุจุฏุงู ุงูุฏุงูุฉ ุงููุฏููุฉ ุจุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ ุงูุชุงููุฉ.
ุงูููู: student_performance_app_full.py
ุงููููุน: ุงุณุชุจุฏู ุงูุฏุงูุฉ create_student_report_pdf ุจุงููุงูู ุจุงูููุฏ ุงูุชุงูู:
Python
# ----------------------------------------------------------------------
# ุฏุงูุฉ ุฅูุดุงุก ุชูุฑูุฑ ุงูุทุงูุจ ุงููุฑุฏู (PDF) - ุชุตููู ุฌุฏูุฏ
# ----------------------------------------------------------------------
def create_student_report_pdf(student_data: pd.Series, raw_df: pd.DataFrame, school_info: dict, custom_recommendation: str = "") -> BytesIO:
    """ุชูุดุฆ ุชูุฑูุฑ PDF ูุฑุฏู ููุทุงูุจ ุจูุงุกู ุนูู ุงููููุฐุฌ ุงููุฑูู."""
    from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, Image
    from reportlab.lib.styles import getSampleStyleSheet
    from reportlab.lib.units import inch, mm
    from reportlab.lib import colors
    
    mem = BytesIO()
    
    # ุฅุนุฏุงุฏุงุช ุงูุชูุซูู
    doc = SimpleDocTemplate(
        mem,
        pagesize=A4,
        rightMargin=10*mm, leftMargin=10*mm,
        topMargin=10*mm, bottomMargin=10*mm
    )
    
    styles = getSampleStyleSheet()
    # ุฃููุงุท ูุฎุตุตุฉ ููุบุฉ ุงูุนุฑุจูุฉ (ูุญุงุฐุงุฉ ูููููู)
    styles.add(ParagraphStyle(name='RightAlign', alignment=TA_RIGHT, fontName='Helvetica', fontSize=12))
    styles.add(ParagraphStyle(name='Heading1Right', alignment=TA_RIGHT, fontName='Helvetica-Bold', fontSize=18))
    styles.add(ParagraphStyle(name='Heading2Right', alignment=TA_RIGHT, fontName='Helvetica-Bold', fontSize=14))
    styles.add(ParagraphStyle(name='SmallRight', alignment=TA_RIGHT, fontName='Helvetica', fontSize=10))
    
    # ุจูุงูุงุช ุงููุฏุฑุณุฉ
    school_name = school_info.get("School_Name", "ุงููุฏุฑุณุฉ")
    coordinator = school_info.get("Coordinator", "N/A")
    academic_deputy = school_info.get("Academic_Deputy", "N/A")
    administrative_deputy = school_info.get("Administrative_Deputy", "N/A")
    principal = school_info.get("Principal", "N/A")
    
    # ูุญุชูู ุงูุชูุฑูุฑ
    elements = []
    
    # 1. ุฑุฃุณ ุงูุชูุฑูุฑ ูุงูุดุนุงุฑุงุช (ูุญุงูุงุฉ)
    MINISTRY_LOGO = "https://i.imgur.com/jFzu8As.jpeg"
    QATAR_SYSTEM_LOGO = "https://i.imgur.com/AtRkvQY.jpeg"
    
    # ุฅูุดุงุก ุฌุฏูู ูุฑุฃุณ ุงูุตูุญุฉ (ุงูุดุนุงุฑุงุช ูุงูุนููุงู )
    header_data = [
        [
            Image(MINISTRY_LOGO, width=40*mm, height=15*mm),
            Paragraph(f"<b>{school_name}</b>", styles['Heading2Right']),
            Image(QATAR_SYSTEM_LOGO, width=40*mm, height=15*mm)
        ],
        [
            Paragraph("ุงูุนุงู ุงูุฃูุงุฏููู 2025-2026", styles['SmallRight']),
            Paragraph("ุชูุฑูุฑ ุฃุฏุงุก ุงูุทุงูุจ ุนูู ูุธุงู ูุทุฑ ููุชุนููู", styles['Heading1Right']),
            Paragraph("", styles['SmallRight'])
        ]
    ]
    
    header_table = Table(header_data, colWidths=[50*mm, 100*mm, 50*mm])
    header_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'CENTER'),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('SPAN', (1,1), (2,1)), # ุฏูุฌ ุฎูุงูุง ุงูุนููุงู
        ('BOTTOMPADDING', (0,0), (-1,-1), 5*mm),
    ]))
    elements.append(header_table)
    elements.append(Spacer(1, 0.5 * inch))
    
    # 2. ูุนูููุงุช ุงูุทุงูุจ
    elements.append(Paragraph("<b>ูุนูููุงุช ุงูุทุงูุจ:</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    student_info_data = [
        [
            Paragraph(f"<b>:ุจูุงุทูุง ูุณุง</b> {student_data['ุงุณู ุงูุทุงูุจ']}", styles['RightAlign']),
            Paragraph(f"<b>:ูุตูุง</b> {student_data['ุงูุตู']}", styles['RightAlign']),
            Paragraph(f"<b>:ุฉุจุนุดูุง</b> {student_data['ุงูุดุนุจุฉ']}", styles['RightAlign']),
        ]
    ]
    student_info_table = Table(student_info_data, colWidths=[doc.width/3]*3)
    student_info_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
        ('BOTTOMPADDING', (0,0), (-1,-1), 5*mm),
    ]))
    elements.append(student_info_table)
    elements.append(Spacer(1, 0.2 * inch))
    
    # 3. ุฌุฏูู ุฃุฏุงุก ุงูููุงุฏ
    elements.append(Paragraph("<b>ุงูุฃุฏุงุก ุญุณุจ ุงููุงุฏุฉ:</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    # ุฅุนุฏุงุฏ ุจูุงูุงุช ุงูุฌุฏูู
    subject_data_table = [
        [
            Paragraph("<b>ุฉุฏุงููุง</b>", styles['SmallRight']),
            Paragraph("<b>ููุงูุฌูุงุง ุชุงููููุชูุง ุฏุฏุน</b>", styles['SmallRight']),
            Paragraph("<b>ุฉุฒุฌูููุง ุชุงููููุชูุง ุฏุฏุน</b>", styles['SmallRight']),
            Paragraph("<b>ุฉููุจุชููุง ุชุงููููุชูุง ุฏุฏุน</b>", styles['SmallRight']),
        ]
    ]
    
    subject_cols = [col.split('_')[0] for col in student_data.index if col.endswith('_total') and col != 'Overall_Total']
    
    for subj in subject_cols:
        solved = student_data.get(f"{subj}_solved", 0)
        total = student_data.get(f"{subj}_total", 0)
        pending = total - solved
        
        subject_data_table.append([
            Paragraph(subj, styles['SmallRight']),
            Paragraph(str(total), styles['SmallRight']),
            Paragraph(str(solved), styles['SmallRight']),
            Paragraph(str(pending), styles['SmallRight']),
        ])
        
    # ุชูุณูู ุงูุฌุฏูู
    table_style = TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'CENTER'),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('BACKGROUND', (0, 0), (-1, 0), colors.Color(red=(0x80/255), green=0, blue=(0x20/255), alpha=0.1)), # ุฎูููุฉ ุนูุงุจูุฉ ูุงุชุญุฉ
        ('GRID', (0, 0), (-1, -1), 0.5, colors.grey),
        ('LEFTPADDING', (0,0), (-1,-1), 5),
        ('RIGHTPADDING', (0,0), (-1,-1), 5),
    ])
    
    subj_table = Table(subject_data_table, colWidths=[doc.width/4]*4)
    subj_table.setStyle(table_style)
    elements.append(subj_table)
    elements.append(Spacer(1, 0.2 * inch))
    
    # 4. ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ
    elements.append(Paragraph("<b>:ุชุงูุฆุงุตุญูุงุง</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    overall_solved = student_data['ุฅุฌูุงูู ุงูุชููููุงุช']
    overall_total = student_data['ุงูููุฌุฒ']
    overall_completion = student_data['ูุณุจุฉ ุงูุฅูุฌุงุฒ %']
    overall_pending = overall_total - overall_solved
    
    stats_data = [
        [
            Paragraph(f"<b>ุฉุจุณู ูุญ ุชุงููููุชูุง</b> {overall_completion:.2f}%", styles['RightAlign']),
            Paragraph(f"<b>ููุจุชู</b> {overall_pending}", styles['RightAlign']),
            Paragraph(f"<b>ุฒุฌูู</b> {overall_solved}", styles['RightAlign']),
        ]
    ]
    stats_table = Table(stats_data, colWidths=[doc.width/3]*3)
    stats_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
    ]))
    elements.append(stats_table)
    elements.append(Spacer(1, 0.2 * inch))
    
    # 5. ุงูุชูุตูุฉ (ููุณู ุงููุดุงุฑูุน)
    elements.append(Paragraph("<b>:ุนูุฑุงุดููุง ูุณูู ุฉูุตูุช</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    final_recommendation = custom_recommendation if custom_recommendation else student_data['ุชูุตูุฉ ุงูุทุงูุจ']
    
    # ุงุณุชุฎุฏุงู ููุท ุงูููุฑุฉ ููุชูุตูุฉ
    elements.append(Paragraph(final_recommendation, styles['RightAlign']))
    elements.append(Spacer(1, 0.5 * inch))
    
    # 6. ุงูุชูููุนุงุช (Footer/Contact)
    elements.append(Paragraph("<b>ููุชูุงุตู ูุงูุชูููุนุงุช:</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    contact_data = [
        [
            Paragraph(f"<b>ูุฏูุฑ ุงููุฏุฑุณุฉ:</b> {principal}", styles['SmallRight']),
            Paragraph(f"<b>ุงููุงุฆุจ ุงูุฅุฏุงุฑู:</b> {administrative_deputy}", styles['SmallRight']),
            Paragraph(f"<b>ุงููุงุฆุจ ุงูุฃูุงุฏููู:</b> {academic_deputy}", styles['SmallRight']),
            Paragraph(f"<b>ููุณู ุงููุดุงุฑูุน ุงูุฅููุชุฑูููุฉ:</b> {coordinator}", styles['SmallRight']),
        ]
    ]
    contact_table = Table(contact_data, colWidths=[doc.width/4]*4)
    contact_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
    ]))
    elements.append(contact_table)
    elements.append(Spacer(1, 0.2 * inch))
    
    # 7. ุงูุฑุคูุฉ ูุงูุฑูุงุจุท
    elements.append(Paragraph("<b>ุฑุคูุชูุง: ูุชุนูู ุฑูุงุฏู ูุชูููุฉ ูุณุชุฏุงูุฉ</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    links_data = [
        [
            Paragraph("<b>ุฑุงุจุท ูุธุงู ูุทุฑ:</b> https://qeducation.edu.gov.qa", styles['SmallRight'] ),
            Paragraph("<b>ูููุน ุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ:</b> https://pwdreset.edu.gov.qa", styles['SmallRight'] ),
        ]
    ]
    links_table = Table(links_data, colWidths=[doc.width/2]*2)
    links_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
    ]))
    elements.append(links_table)
    
    # ุจูุงุก ุงููุณุชูุฏ
    doc.build(elements)
    mem.seek(0)
    return mem
ุงูุชุนุฏูู 2: ุฅุถุงูุฉ ุงุณุชูุฑุงุฏุงุช reportlab ุงูุถุฑูุฑูุฉ
ูุชุดุบูู ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉุ ูุฌุจ ุฅุถุงูุฉ ุงุณุชูุฑุงุฏุงุช ุฅุถุงููุฉ ูู reportlab.
ุงููููุน: ูู ุจุฏุงูุฉ ุงููููุ ุถูู ูุณู ุงูุงุณุชูุฑุงุฏุงุช.
Python
# ุงุจุญุซ ุนู:
from reportlab.lib.units import mm
from reportlab.lib.utils import ImageReader

# ูุฃุถู ุจุนุฏูุง:
from reportlab.platypus import Paragraph, Table, TableStyle, Spacer, SimpleDocTemplate, Image
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.enums import TA_RIGHT
ุงูููุฏ ุงููุงูู ุงููุญุฏุซ
ุจูุง ุฃูู ุทูุจุช ุงูููุฏ ูุงููุงูุ ุณุฃููู ุจุชุฌููุน ุฌููุน ุงูุชุนุฏููุงุช ุงูุณุงุจูุฉ (ุงูุนููุงูุ ุงูุฃููููุงุชุ ุงูููุชุฑุ ูุงุฌูุฉ ุงููุฏุฑุณุฉุ ููุงุชุฑ ุงูุชุงุฑูุฎ/ุงูุฃูุฑุงูุ ูุชุทููุฑ ุงูุชูุงุฑูุฑ) ูู ููู ูุงุญุฏ.
ุงูููู ุงููุฑูู: student_performance_app_full_final.py
ุงูุฑุฌุงุก ููุงุญุธุฉ:
ููุชุดุบูู ุงูุตุญูุญุ ูุฌุจ ุฃู ูููู ูุฏูู ููู config.toml ูู ูุฌูุฏ .streamlit ูุชุทุจูู ุงูุซูู ุงูุนูุงุจู.
ูุฌุจ ุชุซุจูุช ุฌููุน ุงูููุชุจุงุช: pip install streamlit pandas plotly openpyxl reportlab openai.
ุณุฃููู ุงูุขู ุจุชูููุฏ ุงูููุฏ ุงููุงูู.
Provide the full updated `student_performance_app_full.py` code.
Suggested new knowledge
Lite
ุจุงูุชุฃููุฏุ ุฅููู ุงูููุฏ ุงููุงูู ูุงููุญุฏุซ student_performance_app_full.py ุงูุฐู ูุชุถูู ุฌููุน ุงูุชุนุฏููุงุช ุงูุชู ุทูุจุชู:
ุฅุตูุงุญ ูุดููุฉ KeyError: 'uid'
ุฅุถุงูุฉ ููุงุชุฑ ุงูุชุงุฑูุฎ ูุงูุฃูุฑุงู
ุฅุถุงูุฉ ูุงุฌูุฉ ุฅุฏุฎุงู ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุงููุณุคูููู
ุชุนุฏูู ุงูุนููุงู ูุงูุดุนุงุฑ (ุฌูุฏุฉ ุงูุฃุฏุงุก ุนูู ูุทุฑ ููุชุนููู)
ุฅุถุงูุฉ ุงูููุชุฑ (Footer) ุงููุฎุตุต
ุชุทููุฑ ุฏุงูุฉ ุฅูุดุงุก ุงูุชูุฑูุฑ ุงููุฑุฏู (PDF) ุจูุงุกู ุนูู ุงููููุฐุฌ ุงููุฑูู.
ุชุทููุฑ ุฏุงูุฉ ุงูุชูุฑูุฑ ุงูููู ุงููุตูู (Excel).
ุฅุถุงูุฉ ูุธููุฉ ุชุญููู ุจูุงูุงุช ุงููุนูููู ูุฅุฑุณุงู ุชูุจููุงุช ููุทูุงุจ ุบูุฑ ุงููุงุนููู.
Python
# -*- coding: utf-8 -*-
"""
๐ ุฃู ุฅูุฌุงุฒ โ ููุญุฉ ุชุญููู ุฅูุฌุงุฒ ุงูุทูุงุจ (Purple/White)
- ุงุฎุชูุงุฑ ุฃูุฑุงู Excel ูู ุงูุดุฑูุท ุงูุฌุงูุจู
- ุฑุจุท ุณุฌู ุงูููุฏ (ุฑูู ุดุฎุตู + ุตู + ุดุนุจุฉ) ุจุชุทุจูุน ุงูุงุณู
- ensure_uid: uid ููุญูุฏ + ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช
- Pivot: ูู ุทุงูุจ ุตู ูุงุญุฏ
- ุฑุณูู ุนุงูุฉ + ูุฆุงุช + ููุงุฏ
- ุชูุตูุงุช ุชุดุบูููุฉ ูุฑูุน ูุณุจุฉ ุงูุฅูุฌุงุฒ (ุบูุฑ ุฃูุงุฏูููุฉ)
- ุชุตุฏูุฑ Excel ุดุงูู + PDF ูุฑุฏู ููู ุทุงูุจ ุฏุงุฎู ZIP
- ุญูุธ ุงูุฌุฏุงูู ูู session_state ูุซุจุงุช ุฃุฒุฑุงุฑ ุงูุชุตุฏูุฑ
- ููุฒุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ุชุญููู ุงูุฃููุงุทุ ูุงูุชูุตูุงุช ุงููุฎุตุตุฉ ุจุงุณุชุฎุฏุงู LLM
"""

import streamlit as st
import pandas as pd
import plotly.express as px
from io import BytesIO
import re, zipfile
from typing import Dict, List, Tuple, Optional
from reportlab.lib.pagesizes import A4
from reportlab.lib.colors import Color
from reportlab.lib.units import mm
from reportlab.lib.utils import ImageReader
from reportlab.platypus import Paragraph, Table, TableStyle, Spacer, SimpleDocTemplate, Image
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.enums import TA_RIGHT
from reportlab.lib import colors
from reportlab.lib.units import inch

# --------------- ุฅุนุฏุงุฏ ุงูุตูุญุฉ ---------------
# ุฑุงุจุท ุดุนุงุฑ ุฅูุฌุงุฒ (ุงููุฎุทุท ุงูุจูุงูู ุงููููู)
INGAZ_ICON = "https://i.imgur.com/pasted_file_gkR2PR_image.png" 
st.set_page_config(page_title="ุฃู ุฅูุฌุงุฒ", page_icon=INGAZ_ICON, layout="wide" )

# --------------- ุงูุซูุงุจุช ---------------
POSITIVE_STATUS = ["solved","yes","1","ุชู","ููุฌุฒ","โ","โ","ุตุญูุญ"]

STUDENT_RECOMMENDATIONS = {
    "๐ Platinum": "ูุซูู ุชููุฒู ุงููุณุชูุฑุ ููุฏ ุฃุธูุฑุช ุฅุจุฏุงุนูุง ูุงุฌุชูุงุฏูุง ููุญูุธูุง. ุงุณุชูุฑ ูู ุงุณุชุฎุฏุงู ูุธุงู ูุทุฑ ููุชุนููู ุจูุนุงููุฉุ ูุฃูุช ูููุฐุฌ ูุญุชุฐู ุจู.",
    "๐ฅ Gold": "ุฃุญุณูุช! ูุณุชูุงู ูุนูุณ ุงูุชุฒุงููุง ุฑุงุฆุนูุงุ ูุซู ุฃูู ุจูุชุงุจุนุฉ ุงูุฌูุฏ ุณุชูุชูู ููุณุชูู ุฃุนูู. ุงุณุชูุฑ ูู ุชูุนูู ูุธุงู ูุทุฑ ุฏุงุฎู ุงูุตู.",
    "๐ฅ Silver": "ุนููู ุฌูุฏ ููุณุชุญู ุงูุชูุฏูุฑุ ููุน ูุฒูุฏ ูู ุงูููุงุฑุณุฉ ูุงูุชูุงุนู ูุน ูุธุงู ูุทุฑ ุณุชุตู ุฅูู ูุณุชููุงุช ุฃุฑูุน. ูุญู ูุฎูุฑูู ุจู.",
    "๐ฅ Bronze": "ููุฏ ุฃุธูุฑุช ุฌูุฏูุง ูุดููุฑูุงุ ููุดุฌุนู ุนูู ุจุฐู ุงููุฒูุฏ ูู ุงูุนุทุงุก. ุจุงุณุชุฎุฏุงู ูุธุงู ูุทุฑ ุจุดูู ุฃุนูู ุณุชุชุทูุฑ ูุฏุฑุงุชู ุจุดูู ุฃูุจุฑ.",
    "๐ง Needs Improvement": "ูุฑู ูุฏูู ุฅููุงููุงุช ูุงุนุฏุฉุ ููู ุชุญุชุงุฌ ููุฒูุฏ ูู ุงูุงูุชุฒุงู ุจุงุณุชุฎุฏุงู ูุธุงู ูุทุฑ ููุชุนููู. ููุตูู ุจุงููุซุงุจุฑุฉ ูุงููุดุงุฑูุฉ ุงููุดุทุฉุ ููุญู ุจุฌุงูุจู ูุชุชูุฏู.",
    "๐ซ Not Utilizing System": "ูู ูุธูุฑ ุจุนุฏ ุงุณุชูุงุฏุฉ ูุงููุฉ ูู ูุธุงู ูุทุฑ ููุชุนูููุ ููุฏุนูู ุฅูู ุชูุนูู ุงููุธุงู ุจุดูู ุฃูุจุฑ ูุชุญููู ุงููุฌุงุญ. ูุญู ูุซู ุฃู ูุฏูู ุงููุฏุฑุฉ ุนูู ุงูุชุบููุฑ ูุงูุชููุฒ."
}

# --------------- ููุฏ ุงูููุชุฑ (Footer) ---------------
FOOTER_MARKDOWN = """
<style>
    .footer {
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100%;
        background-color: #f0f2f6; /* ููู ุฎูููุฉ ูุงุชุญ */
        color: #800020; /* ููู ุงููุต ุนูุงุจู */
        text-align: center;
        padding: 10px 0;
        font-size: 14px;
        border-top: 1px solid #800020; /* ุฎุท ุนูุงุจู ูุงุตู */
    }
    .footer a {
        color: #800020; /* ููู ุงูุฑูุงุจุท ุนูุงุจู */
        text-decoration: none;
    }
</style>
<div class="footer">
    <p>
        <strong>ุฑุคูุชูุง: ูุชุนูู ุฑูุงุฏู ูุชูููุฉ ูุณุชุฏุงูุฉ</strong>  

        ุฌููุน ุงูุญููู ูุญููุธุฉ ยฉ ูุฏุฑุณุฉ ุนุซูุงู ุจู ุนูุงู ุงููููุฐุฌูุฉ  

        ุชุทููุฑ ู ุชูููุฐ: ููุณู ุงููุดุงุฑูุน ุงูุฅููุชุฑููู: ุณุญุฑ ุนุซูุงู  

        ููุชูุงุตู: <a href="mailto:S.mahgoub0101@education.qa">S.mahgoub0101@education.qa</a>
    </p>
</div>
"""
# --------------- ููุงูุฉ ููุฏ ุงูููุชุฑ ---------------

# --------------- ููุฏ ุฑุฃุณ ุงูุตูุญุฉ (Header) ---------------
def display_header():
    # ุฑูุงุจุท ุงูุดุนุงุฑุงุช
    MINISTRY_LOGO = "https://i.imgur.com/jFzu8As.jpeg"
    QATAR_SYSTEM_LOGO = "https://i.imgur.com/AtRkvQY.jpeg"
    
    # ุชูุณูู HTML/CSS ูุชุฑุชูุจ ุงูุดุนุงุฑุงุช ูุงูุนููุงู
    header_html = f"""
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 2px solid #800020;">
        
        <!-- ุงููุณุงุฑ: ุดุนุงุฑ ุงููุฒุงุฑุฉ ูุดุนุงุฑ ุงููุธุงู -->
        <div style="display: flex; align-items: center; gap: 15px;">
            <img src="{MINISTRY_LOGO}" style="height: 60px; object-fit: contain;">
            <img src="{QATAR_SYSTEM_LOGO}" style="height: 60px; object-fit: contain;">
        </div>
        
        <!-- ุงูููุชุตู: ุงูุนููุงู ุงูุฑุฆูุณู (ุฃู ุฅูุฌุงุฒ ) -->
        <div style="text-align: center; flex-grow: 1;">
            <h1 style="color: #800020; margin: 0; font-size: 32px;">
                ุฃู ุฅูุฌุงุฒ - ููุญุฉ ุชุญููู ุฅูุฌุงุฒ ุงูุทูุงุจ ุงูุฐููุฉ
            </h1>
            <p style="color: #555; margin: 5px 0 0 0; font-size: 16px;">
                ุฃุฏุงุฉ ุชุญููููุฉ ุชุนุชูุฏ ุนูู ุงูุชุญููู ุงูุฅุญุตุงุฆู ูุงูุชูุตูุงุช ุงูุซุงุจุชุฉ ุงููุฎุตุตุฉ ูุฑูุน ูุณุจุฉ ุงูุฅูุฌุงุฒ ุงูุฃูุงุฏููู.
            </p>
        </div>
        
        <!-- ุงููููู: ูุณุงุญุฉ ูุงุฑุบุฉ ุฃู ุดุนุงุฑ ุขุฎุฑ ุฅุฐุง ูุฒู ุงูุฃูุฑ -->
        <div style="width: 135px;"></div>
    </div>
    """
    st.markdown(header_html, unsafe_allow_html=True)
# --------------- ููุงูุฉ ููุฏ ุฑุฃุณ ุงูุตูุญุฉ ---------------

# --------------- ุฃุฏูุงุช ูุณุงุนุฏุฉ ---------------
def _strip_invisible_and_diacritics(s: str) -> str:
    """ูุฒูู ุงูุฃุญุฑู ุบูุฑ ุงููุฑุฆูุฉ ูุนูุงูุงุช ุงูุชุดููู ูู ุงููุต."""
    if not isinstance(s, str):
        return s
    s = re.sub(r'[\u200b-\u200f\u202a-\u202e\u2066-\u2069]', '', s)
    s = re.sub(r'[\u064b-\u065e]', '', s)
    return s.strip()

@st.cache_data
def _load_teachers_df(file) -> Optional[pd.DataFrame]:
    """ุชุญููู ููู ุงููุนูููู ูุชูุญูุฏ ุฃุณูุงุก ุงูุฃุนูุฏุฉ."""
    if file is None:
        return None
    
    try:
        if file.name.endswith('.csv'):
            df = pd.read_csv(file)
        else:
            df = pd.read_excel(file)
            
        # ูุญุงููุฉ ุชูุญูุฏ ุฃุณูุงุก ุงูุฃุนูุฏุฉ
        cols = [_strip_invisible_and_diacritics(str(c)) for c in df.columns]
        df.columns = cols
        
        # ุชุญุฏูุฏ ุงูุฃุนูุฏุฉ ุงูุฃุณุงุณูุฉ
        col_map = {}
        for c in cols:
            if 'ุดุนุจุฉ' in c or 'ุตู' in c or 'ูุตู' in c:
                col_map['class_section'] = c
            elif 'ูุนูู' in c or 'ูุฏุฑุณ' in c:
                col_map['teacher_name'] = c
            elif 'ุงูููู' in c or 'ุจุฑูุฏ' in c:
                col_map['teacher_email'] = c
        
        if len(col_map) < 3:
            st.error("ููู ุงููุนูููู ูุฌุจ ุฃู ูุญุชูู ุนูู ุฃุนูุฏุฉ ููุดุนุจุฉุ ุงุณู ุงููุนููุ ูุงูุจุฑูุฏ ุงูุฅููุชุฑููู.")
            return None
        
        df = df[list(col_map.values())]
        df.columns = ['class_section', 'teacher_name', 'teacher_email']
        
        df['class_section'] = df['class_section'].astype(str).apply(_strip_invisible_and_diacritics)
        df['teacher_email'] = df['teacher_email'].astype(str).str.lower().apply(_strip_invisible_and_diacritics)
        
        return df
    except Exception as e:
        st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ููู ุงููุนูููู: {e}")
        return None

@st.cache_data
def process_excel_file(file, filename: str, start_row_students: int, selected_sheets: List[str]) -> List[Dict]:
    """ูุนุงูุฌุฉ ููู Excel ูุงุญุฏ ูุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ุงูุทูุงุจ."""
    try:
        xls = pd.ExcelFile(file)
        data_rows = []
        
        for sheet_name in selected_sheets:
            # ูุฑุงุกุฉ ุงูุจูุงูุงุช ูุน ุชุฎุทู ุงูุตููู ุงูุนูููุฉ
            df = xls.parse(sheet_name, header=None, skiprows=start_row_students - 1)
            
            # ุชุญุฏูุฏ ุฃุนูุฏุฉ ุงูู UID ูุงูุงุณู ูุงูุตู ูุงูุดุนุจุฉ (ุงูุชุฑุงุถูุงู ุฃูู 4 ุฃุนูุฏุฉ)
            if df.shape[1] < 4: continue
            
            df = df.iloc[:, :4].copy()
            df.columns = ['uid', 'ุงุณู ุงูุทุงูุจ', 'ุงูุตู', 'ุงูุดุนุจุฉ']
            
            # ุชุญุฏูุฏ ุฃุนูุฏุฉ ุงูุชููููุงุช (ุจุฏุกุงู ูู ุงูุนููุฏ ุงูุฎุงูุณ)
            assessment_cols = xls.parse(sheet_name, header=None, skiprows=start_row_students - 2, nrows=1).iloc[0, 4:].tolist()
            assessment_data = xls.parse(sheet_name, header=None, skiprows=start_row_students - 1).iloc[:, 4:]
            assessment_data.columns = assessment_cols
            
            # ุฏูุฌ ุจูุงูุงุช ุงูุทุงูุจ ูุน ุจูุงูุงุช ุงูุชูููู
            df = pd.concat([df, assessment_data], axis=1)
            
            # ุชุญููู ุงูุตููู ุฅูู ูุงุฆูุฉ ููุงููุณ
            for _, row in df.iterrows():
                row_dict = row.to_dict()
                row_dict['Source_File'] = filename
                row_dict['Source_Sheet'] = sheet_name
                data_rows.append(row_dict)
                
        return data_rows
    except Exception as e:
        st.error(f"ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูููู {filename} ูุงููุฑูุฉ {sheet_name}: {e}")
        return []

@st.cache_data
def ensure_uid(df: pd.DataFrame) -> pd.DataFrame:
    """ุชูุญูุฏ ุงูู UID ูุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช."""
    if df.empty:
        return df
    
    # ุชูุญูุฏ ุงูู UID ูุงูุงุณู
    df['uid'] = df['uid'].astype(str).apply(_strip_invisible_and_diacritics)
    df['ุงุณู ุงูุทุงูุจ'] = df['ุงุณู ุงูุทุงูุจ'].astype(str).apply(_strip_invisible_and_diacritics)
    df['ุงูุตู'] = df['ุงูุตู'].astype(str).apply(_strip_invisible_and_diacritics)
    df['ุงูุดุนุจุฉ'] = df['ุงูุดุนุจุฉ'].astype(str).apply(_strip_invisible_and_diacritics)
    
    # ุฅุฒุงูุฉ ุงูุตููู ุงูููุฑุฑุฉ ุจูุงุกู ุนูู UID
    df = df.drop_duplicates(subset=['uid'], keep='first')
    
    return df

@st.cache_data
def build_summary_pivot(raw_df: pd.DataFrame, thresholds: Dict[str, float]) -> Tuple[pd.DataFrame, List[str]]:
    """ุจูุงุก ุงูููุฎุต ุงููุญูุฑู ูุฅุถุงูุฉ ุงูุชุตูููุงุช ูุงูุชูุตูุงุช."""
    if raw_df.empty:
        return pd.DataFrame(), []

    # 1. ุชุญุฏูุฏ ุฃุนูุฏุฉ ุงูุชููููุงุช
    assessment_cols = [col for col in raw_df.columns if col not in ['uid', 'ุงุณู ุงูุทุงูุจ', 'ุงูุตู', 'ุงูุดุนุจุฉ', 'Source_File', 'Source_Sheet']]
    
    # 2. ุชุญููู ุงูุจูุงูุงุช ุฅูู ุชูุณูู ุทููู (Long Format)
    long_df = raw_df.melt(
        id_vars=['uid', 'ุงุณู ุงูุทุงูุจ', 'ุงูุตู', 'ุงูุดุนุจุฉ'],
        value_vars=assessment_cols,
        var_name='assessment_name',
        value_name='status'
    ).dropna(subset=['status'])

    # 3. ุงุณุชุฎุฑุงุฌ ุงุณู ุงููุงุฏุฉ (ููุชุฑุถ ุฃู ุงุณู ุงููุงุฏุฉ ูู ุฃูู ูููุฉ)
    long_df['subject'] = long_df['assessment_name'].apply(lambda x: x.split(' ')[0] if isinstance(x, str) else 'ุบูุฑ ูุญุฏุฏ')
    
    # 4. ุชุญุฏูุฏ ุญุงูุฉ ุงูุฅูุฌุงุฒ (Solved/Total)
    long_df['solved'] = long_df['status'].astype(str).apply(lambda x: 1 if _strip_invisible_and_diacritics(x).lower() in POSITIVE_STATUS else 0)
    long_df['total'] = 1

    # 5. ุจูุงุก ุงูุฌุฏูู ุงููุญูุฑู (Pivot Table)
    piv = pd.pivot_table(
        long_df,
        index=['uid', 'ุงุณู ุงูุทุงูุจ', 'ุงูุตู', 'ุงูุดุนุจุฉ'],
        columns='subject',
        values=['solved', 'total'],
        aggfunc='sum',
        fill_value=0
    ).reset_index()

    # 6. ุฅุตูุงุญ ูุดููุฉ ุชุณููุฉ ุงูุฃุนูุฏุฉ ุจุนุฏ pivot_table (ุฅุตูุงุญ KeyError: 'uid')
    new_columns = []
    for col in piv.columns:
        if col[0] in ['uid', 'ุงุณู ุงูุทุงูุจ', 'ุงูุตู', 'ุงูุดุนุจุฉ']:
            new_columns.append(col[0])
        else:
            new_columns.append(f"{col[1]}_{col[0]}")
    piv.columns = new_columns
    
    # 7. ุญุณุงุจ ุงูุฅุฌูุงูู ุงูููู
    subjects = [col.split('_')[0] for col in piv.columns if col.endswith('_total')]
    
    piv['Overall_solved'] = piv[[f"{s}_solved" for s in subjects]].sum(axis=1)
    piv['Overall_total'] = piv[[f"{s}_total" for s in subjects]].sum(axis=1)
    
    # 8. ุญุณุงุจ ูุณุจุฉ ุงูุฅูุฌุงุฒ
    piv['ูุณุจุฉ ุงูุฅูุฌุงุฒ %'] = (piv['Overall_solved'] / piv['Overall_total'] * 100).round(2).fillna(0)
    
    # 9. ุงูุชุตููู (Categorization)
    def cat(x):
        if x == 0:
            return "๐ซ Not Utilizing System"
        elif x > thresholds["Platinum"]:
            return "๐ Platinum"
        elif x > thresholds["Gold"]:
            return "๐ฅ Gold"
        elif x > thresholds["Silver"]:
            return "๐ฅ Silver"
        elif x > thresholds["Bronze"]:
            return "๐ฅ Bronze"
        else:
            return "๐ง Needs Improvement"
            
    piv['ุงููุฆุฉ'] = piv['ูุณุจุฉ ุงูุฅูุฌุงุฒ %'].apply(cat)
    
    # 10. ุฅุถุงูุฉ ุงูุชูุตูุฉ ุงูุซุงุจุชุฉ
    piv['ุชูุตูุฉ ุงูุทุงูุจ'] = piv['ุงููุฆุฉ'].apply(lambda x: STUDENT_RECOMMENDATIONS.get(x, "ูุง ุชูุฌุฏ ุชูุตูุฉ ููุฐุง ุงูุชุตููู."))
    
    # 11. ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงูุฃุนูุฏุฉ
    cols_order = ['uid', 'ุงุณู ุงูุทุงูุจ', 'ุงูุตู', 'ุงูุดุนุจุฉ', 'ูุณุจุฉ ุงูุฅูุฌุงุฒ %', 'ุงููุฆุฉ', 'ุชูุตูุฉ ุงูุทุงูุจ'] + [col for col in piv.columns if col not in ['uid', 'ุงุณู ุงูุทุงูุจ', 'ุงูุตู', 'ุงูุดุนุจุฉ', 'ูุณุจุฉ ุงูุฅูุฌุงุฒ %', 'ุงููุฆุฉ', 'ุชูุตูุฉ ุงูุทุงูุจ']]
    
    return piv[cols_order], subjects

@st.cache_data
def analyze_subject_patterns(summary_df: pd.DataFrame, subject: str) -> str:
    """ุชุญููู ููุท ุงูุฃุฏุงุก ูู ูุงุฏุฉ ูุนููุฉ ูุชูุฏูู ุชูุตูุฉ ุซุงุจุชุฉ."""
    
    solved_col = f"{subject}_solved"
    total_col = f"{subject}_total"
    
    if solved_col not in summary_df.columns or total_col not in summary_df.columns:
        return "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ููุฐู ุงููุงุฏุฉ."
        
    total_students = summary_df.shape[0]
    total_assessments = summary_df[total_col].sum()
    avg_solved = summary_df[solved_col].mean()
    
    # ูุนุงููุฑ ุจุณูุทุฉ ููุชูุตูุฉ (ุซุงุจุชุฉ)
    if total_assessments == 0:
        return f"ุชูุตูุฉ ุงููุงุฏุฉ {subject}: ูู ูุชู ุฅุฏุฎุงู ุฃู ุชููููุงุช ููุฐู ุงููุงุฏุฉ. ูุฑุฌู ุงูุชุฃูุฏ ูู ุฅุฏุฎุงู ุงูุจูุงูุงุช."
    
    avg_completion = (summary_df[solved_col].sum() / total_assessments) * 100
    
    if avg_completion >= 80:
        return f"ุชูุตูุฉ ุงููุงุฏุฉ {subject}: ุฃุฏุงุก ููุชุงุฒ! ูุชูุณุท ุงูุฅูุฌุงุฒ {avg_completion:.2f}%. ูุฑุฌู ุงูุชุฑููุฒ ุนูู ุงูุทูุงุจ ุงูุฐูู ูู ููุฌุฒูุง ุจุนุฏ ูุถูุงู ุงุณุชูุฑุงุฑ ุงูุชููุฒ."
    elif avg_completion >= 50:
        return f"ุชูุตูุฉ ุงููุงุฏุฉ {subject}: ุฃุฏุงุก ุฌูุฏ. ูุชูุณุท ุงูุฅูุฌุงุฒ {avg_completion:.2f}%. ููุถู ูุฑุงุฌุนุฉ ุงูุชููููุงุช ุงูุฃูู ุฅูุฌุงุฒุงู ูุชูุฏูู ุฏุนู ุฅุถุงูู ููุทูุงุจ ูู ุงููุฆุฉ ุงูุจุฑููุฒูุฉ."
    else:
        return f"ุชูุตูุฉ ุงููุงุฏุฉ {subject}: ูุญุชุงุฌ ุฅูู ุชุทููุฑ. ูุชูุณุท ุงูุฅูุฌุงุฒ {avg_completion:.2f}%. ูุฑุฌู ูุฑุงุฌุนุฉ ุทุฑููุฉ ุชูุฏูู ุงูุชููููุงุช ุฃู ุงููุญุชููุ ูุงูุชุฑููุฒ ุนูู ุงูุทูุงุจ ุบูุฑ ุงููุงุนููู."

def to_excel_bytes(dfs: Dict[str, pd.DataFrame]) -> BytesIO:
    """ุชุญููู ูุงููุณ ูู DataFrames ุฅูู ููู Excel ูู ุงูุฐุงูุฑุฉ."""
    mem = BytesIO()
    with pd.ExcelWriter(mem, engine="openpyxl") as writer:
        for sheet_name, df in dfs.items():
            df.to_excel(writer, sheet_name=sheet_name, index=False)
    mem.seek(0)
    return mem

# ----------------------------------------------------------------------
# ุฏุงูุฉ ุฅูุดุงุก ุชูุฑูุฑ ุงูุทุงูุจ ุงููุฑุฏู (PDF) - ุชุตููู ุฌุฏูุฏ
# ----------------------------------------------------------------------
def create_student_report_pdf(student_data: pd.Series, raw_df: pd.DataFrame, school_info: dict, custom_recommendation: str = "") -> BytesIO:
    """ุชูุดุฆ ุชูุฑูุฑ PDF ูุฑุฏู ููุทุงูุจ ุจูุงุกู ุนูู ุงููููุฐุฌ ุงููุฑูู."""
    
    # ูุฌุจ ุงุณุชูุฑุงุฏ ูุฐู ุงูููุชุจุงุช ุฏุงุฎู ุงูุฏุงูุฉ ูุถูุงู ุนูููุง ุจุดูู ุตุญูุญ
    from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, Image
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.enums import TA_RIGHT
    from reportlab.lib import colors
    from reportlab.lib.units import inch, mm
    
    mem = BytesIO()
    
    # ุฅุนุฏุงุฏุงุช ุงูุชูุซูู
    doc = SimpleDocTemplate(
        mem,
        pagesize=A4,
        rightMargin=10*mm, leftMargin=10*mm,
        topMargin=10*mm, bottomMargin=10*mm
    )
    
    styles = getSampleStyleSheet()
    # ุฃููุงุท ูุฎุตุตุฉ ููุบุฉ ุงูุนุฑุจูุฉ (ูุญุงุฐุงุฉ ูููููู)
    styles.add(ParagraphStyle(name='RightAlign', alignment=TA_RIGHT, fontName='Helvetica', fontSize=12))
    styles.add(ParagraphStyle(name='Heading1Right', alignment=TA_RIGHT, fontName='Helvetica-Bold', fontSize=18))
    styles.add(ParagraphStyle(name='Heading2Right', alignment=TA_RIGHT, fontName='Helvetica-Bold', fontSize=14))
    styles.add(ParagraphStyle(name='SmallRight', alignment=TA_RIGHT, fontName='Helvetica', fontSize=10))
    
    # ุจูุงูุงุช ุงููุฏุฑุณุฉ
    school_name = school_info.get("School_Name", "ุงููุฏุฑุณุฉ")
    coordinator = school_info.get("Coordinator", "N/A")
    academic_deputy = school_info.get("Academic_Deputy", "N/A")
    administrative_deputy = school_info.get("Administrative_Deputy", "N/A")
    principal = school_info.get("Principal", "N/A")
    
    # ูุญุชูู ุงูุชูุฑูุฑ
    elements = []
    
    # 1. ุฑุฃุณ ุงูุชูุฑูุฑ ูุงูุดุนุงุฑุงุช (ูุญุงูุงุฉ)
    MINISTRY_LOGO = "https://i.imgur.com/jFzu8As.jpeg"
    QATAR_SYSTEM_LOGO = "https://i.imgur.com/AtRkvQY.jpeg"
    
    # ุฅูุดุงุก ุฌุฏูู ูุฑุฃุณ ุงูุตูุญุฉ (ุงูุดุนุงุฑุงุช ูุงูุนููุงู )
    header_data = [
        [
            Image(MINISTRY_LOGO, width=40*mm, height=15*mm),
            Paragraph(f"<b>{school_name}</b>", styles['Heading2Right']),
            Image(QATAR_SYSTEM_LOGO, width=40*mm, height=15*mm)
        ],
        [
            Paragraph("ุงูุนุงู ุงูุฃูุงุฏููู 2025-2026", styles['SmallRight']),
            Paragraph("ุชูุฑูุฑ ุฃุฏุงุก ุงูุทุงูุจ ุนูู ูุธุงู ูุทุฑ ููุชุนููู", styles['Heading1Right']),
            Paragraph("", styles['SmallRight'])
        ]
    ]
    
    header_table = Table(header_data, colWidths=[50*mm, 100*mm, 50*mm])
    header_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'CENTER'),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('SPAN', (1,1), (2,1)), # ุฏูุฌ ุฎูุงูุง ุงูุนููุงู
        ('BOTTOMPADDING', (0,0), (-1,-1), 5*mm),
    ]))
    elements.append(header_table)
    elements.append(Spacer(1, 0.5 * inch))
    
    # 2. ูุนูููุงุช ุงูุทุงูุจ
    elements.append(Paragraph("<b>ูุนูููุงุช ุงูุทุงูุจ:</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    student_info_data = [
        [
            Paragraph(f"<b>:ุจูุงุทูุง ูุณุง</b> {student_data['ุงุณู ุงูุทุงูุจ']}", styles['RightAlign']),
            Paragraph(f"<b>:ูุตูุง</b> {student_data['ุงูุตู']}", styles['RightAlign']),
            Paragraph(f"<b>:ุฉุจุนุดูุง</b> {student_data['ุงูุดุนุจุฉ']}", styles['RightAlign']),
        ]
    ]
    student_info_table = Table(student_info_data, colWidths=[doc.width/3]*3)
    student_info_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
        ('BOTTOMPADDING', (0,0), (-1,-1), 5*mm),
    ]))
    elements.append(student_info_table)
    elements.append(Spacer(1, 0.2 * inch))
    
    # 3. ุฌุฏูู ุฃุฏุงุก ุงูููุงุฏ
    elements.append(Paragraph("<b>ุงูุฃุฏุงุก ุญุณุจ ุงููุงุฏุฉ:</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    # ุฅุนุฏุงุฏ ุจูุงูุงุช ุงูุฌุฏูู
    subject_data_table = [
        [
            Paragraph("<b>ุฉุฏุงููุง</b>", styles['SmallRight']),
            Paragraph("<b>ููุงูุฌูุงุง ุชุงููููุชูุง ุฏุฏุน</b>", styles['SmallRight']),
            Paragraph("<b>ุฉุฒุฌูููุง ุชุงููููุชูุง ุฏุฏุน</b>", styles['SmallRight']),
            Paragraph("<b>ุฉููุจุชููุง ุชุงููููุชูุง ุฏุฏุน</b>", styles['SmallRight']),
        ]
    ]
    
    subject_cols = [col.split('_')[0] for col in student_data.index if col.endswith('_total') and col not in ['Overall_total']]
    
    for subj in subject_cols:
        solved = student_data.get(f"{subj}_solved", 0)
        total = student_data.get(f"{subj}_total", 0)
        pending = total - solved
        
        subject_data_table.append([
            Paragraph(subj, styles['SmallRight']),
            Paragraph(str(total), styles['SmallRight']),
            Paragraph(str(solved), styles['SmallRight']),
            Paragraph(str(pending), styles['SmallRight']),
        ])
        
    # ุชูุณูู ุงูุฌุฏูู
    table_style = TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'CENTER'),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('BACKGROUND', (0, 0), (-1, 0), colors.Color(red=(0x80/255), green=0, blue=(0x20/255), alpha=0.1)), # ุฎูููุฉ ุนูุงุจูุฉ ูุงุชุญุฉ
        ('GRID', (0, 0), (-1, -1), 0.5, colors.grey),
        ('LEFTPADDING', (0,0), (-1,-1), 5),
        ('RIGHTPADDING', (0,0), (-1,-1), 5),
    ])
    
    subj_table = Table(subject_data_table, colWidths=[doc.width/4]*4)
    subj_table.setStyle(table_style)
    elements.append(subj_table)
    elements.append(Spacer(1, 0.2 * inch))
    
    # 4. ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ
    elements.append(Paragraph("<b>:ุชุงูุฆุงุตุญูุงุง</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    overall_solved = student_data['Overall_solved']
    overall_total = student_data['Overall_total']
    overall_completion = student_data['ูุณุจุฉ ุงูุฅูุฌุงุฒ %']
    overall_pending = overall_total - overall_solved
    
    stats_data = [
        [
            Paragraph(f"<b>ุฉุจุณู ูุญ ุชุงููููุชูุง</b> {overall_completion:.2f}%", styles['RightAlign']),
            Paragraph(f"<b>ููุจุชู</b> {overall_pending}", styles['RightAlign']),
            Paragraph(f"<b>ุฒุฌูู</b> {overall_solved}", styles['RightAlign']),
        ]
    ]
    stats_table = Table(stats_data, colWidths=[doc.width/3]*3)
    stats_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
    ]))
    elements.append(stats_table)
    elements.append(Spacer(1, 0.2 * inch))
    
    # 5. ุงูุชูุตูุฉ (ููุณู ุงููุดุงุฑูุน)
    elements.append(Paragraph("<b>:ุนูุฑุงุดููุง ูุณูู ุฉูุตูุช</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    final_recommendation = custom_recommendation if custom_recommendation else student_data['ุชูุตูุฉ ุงูุทุงูุจ']
    
    # ุงุณุชุฎุฏุงู ููุท ุงูููุฑุฉ ููุชูุตูุฉ
    elements.append(Paragraph(final_recommendation, styles['RightAlign']))
    elements.append(Spacer(1, 0.5 * inch))
    
    # 6. ุงูุชูููุนุงุช (Footer/Contact)
    elements.append(Paragraph("<b>ููุชูุงุตู ูุงูุชูููุนุงุช:</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    contact_data = [
        [
            Paragraph(f"<b>ูุฏูุฑ ุงููุฏุฑุณุฉ:</b> {principal}", styles['SmallRight']),
            Paragraph(f"<b>ุงููุงุฆุจ ุงูุฅุฏุงุฑู:</b> {administrative_deputy}", styles['SmallRight']),
            Paragraph(f"<b>ุงููุงุฆุจ ุงูุฃูุงุฏููู:</b> {academic_deputy}", styles['SmallRight']),
            Paragraph(f"<b>ููุณู ุงููุดุงุฑูุน ุงูุฅููุชุฑูููุฉ:</b> {coordinator}", styles['SmallRight']),
        ]
    ]
    contact_table = Table(contact_data, colWidths=[doc.width/4]*4)
    contact_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
    ]))
    elements.append(contact_table)
    elements.append(Spacer(1, 0.2 * inch))
    
    # 7. ุงูุฑุคูุฉ ูุงูุฑูุงุจุท
    elements.append(Paragraph("<b>ุฑุคูุชูุง: ูุชุนูู ุฑูุงุฏู ูุชูููุฉ ูุณุชุฏุงูุฉ</b>", styles['Heading2Right']))
    elements.append(Spacer(1, 0.1 * inch))
    
    links_data = [
        [
            Paragraph("<b>ุฑุงุจุท ูุธุงู ูุทุฑ:</b> https://qeducation.edu.gov.qa", styles['SmallRight'] ),
            Paragraph("<b>ูููุน ุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ:</b> https://pwdreset.edu.gov.qa", styles['SmallRight'] ),
        ]
    ]
    links_table = Table(links_data, colWidths=[doc.width/2]*2)
    links_table.setStyle(TableStyle([
        ('ALIGN', (0,0), (-1,-1), 'RIGHT'),
    ]))
    elements.append(links_table)
    
    # ุจูุงุก ุงููุณุชูุฏ
    doc.build(elements)
    mem.seek(0)
    return mem
# ----------------------------------------------------------------------

# ----------------------------------------------------------------------
# ุฏุงูุฉ ุฅูุดุงุก ุงูุชูุฑูุฑ ุงูููู ุงููุตูู (Excel)
# ----------------------------------------------------------------------
def create_quantitative_report_excel(summary_df: pd.DataFrame, subjects: List[str]) -> BytesIO:
    """ุชูุดุฆ ุชูุฑูุฑ Excel ููู ูุตูู ุนูู ูุณุชูู ุงููุงุฏุฉ ูุงูุดุนุจุฉ."""
    mem = BytesIO()
    with pd.ExcelWriter(mem, engine="openpyxl") as w:
        
        # 1. ุชูุฑูุฑ ุงูุฃุฏุงุก ุญุณุจ ุงููุงุฏุฉ
        subject_performance = []
        for subj in subjects:
            total_solved = summary_df.get(f"{subj}_solved", pd.Series([0])).sum()
            total_total = summary_df.get(f"{subj}_total", pd.Series([0])).sum()
            avg_completion = (total_solved / total_total * 100) if total_total > 0 else 0
            
            # ุงูุญุตูู ุนูู ุงูุชูุตูุฉ ุงูุซุงุจุชุฉ ูููุงุฏุฉ
            recommendation = analyze_subject_patterns(summary_df, subj)
            
            subject_performance.append({
                "ุงููุงุฏุฉ": subj,
                "ุฅุฌูุงูู ุงูููุฌุฒ": total_solved,
                "ุฅุฌูุงูู ุงูุชููููุงุช": total_total,
                "ูุชูุณุท ุงูุฅูุฌุงุฒ %": f"{avg_completion:.2f}%",
                "ุงูุชูุตูุฉ ุงูุชุดุบูููุฉ": recommendation
            })
        
        df_subj = pd.DataFrame(subject_performance)
        df_subj.to_excel(w, sheet_name="ููุฎุต ุงูุฃุฏุงุก ุญุณุจ ุงููุงุฏุฉ", index=False)
        
        # 2. ุชูุฑูุฑ ุงูุฃุฏุงุก ุญุณุจ ุงูุดุนุจุฉ ูุงููุงุฏุฉ
        report_data = []
        for (class_name, section), group in summary_df.groupby(["ุงูุตู", "ุงูุดุนุจุฉ"]):
            for subj in subjects:
                total_solved = group.get(f"{subj}_solved", pd.Series([0])).sum()
                total_total = group.get(f"{subj}_total", pd.Series([0])).sum()
                avg_completion = (total_solved / total_total * 100) if total_total > 0 else 0
                
                report_data.append({
                    "ุงูุตู": class_name,
                    "ุงูุดุนุจุฉ": section,
                    "ุงููุงุฏุฉ": subj,
                    "ุฅุฌูุงูู ุงูููุฌุฒ": total_solved,
                    "ุฅุฌูุงูู ุงูุชููููุงุช": total_total,
                    "ูุชูุณุท ุงูุฅูุฌุงุฒ %": f"{avg_completion:.2f}%"
                })
        
        df_class_subj = pd.DataFrame(report_data)
        df_class_subj.to_excel(w, sheet_name="ุงูุฃุฏุงุก ุญุณุจ ุงูุดุนุจุฉ ูุงููุงุฏุฉ", index=False)
        
    mem.seek(0)
    return mem
# ----------------------------------------------------------------------

def send_teacher_emails(summary_df: pd.DataFrame, inactive_threshold: float):
    """ุชูููุฏ ุชูุจููุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููุนูููู ุญูู ุงูุทูุงุจ ุบูุฑ ุงููุงุนููู."""
    if 'teacher_email' not in summary_df.columns:
        st.error("ูุง ูููู ุฅุฑุณุงู ุงูุฅููููุงุช. ูุฑุฌู ุงูุชุฃูุฏ ูู ุชุญููู ููู ุงููุนูููู ูุฑุจุทู ุจุจูุงูุงุช ุงูุทูุงุจ.")
        return
    
    # ุชุญุฏูุฏ ุงูุทูุงุจ ุบูุฑ ุงููุงุนููู
    inactive_students = summary_df[summary_df['ูุณุจุฉ ุงูุฅูุฌุงุฒ %'] <= inactive_threshold]
    
    if inactive_students.empty:
        st.success("ูุง ููุฌุฏ ุทูุงุจ ุบูุฑ ูุงุนููู (ุฃูู ูู ุงูุญุฏ ุงููุญุฏุฏ).")
        return
        
    # ุชุฌููุน ุญุณุจ ุงููุนููุฉ
    email_groups = inactive_students.groupby(['teacher_email', 'teacher_name'])
    
    st.info(f"ุชู ุชุญุฏูุฏ {inactive_students.shape[0]} ุทุงูุจ ุบูุฑ ูุงุนู ุณูุชู ุฅุฑุณุงู ุชูุจููุงุช ุจุดุฃููู ุฅูู {len(email_groups)} ูุนููุฉ.")
    
    for (email, name), group in email_groups:
        student_list = "\n".join([f"- {row['ุงุณู ุงูุทุงูุจ']} ({row['ุงูุตู']}/{row['ุงูุดุนุจุฉ']})" for _, row in group.iterrows()])
        
        # ุงูุชูุตูุฉ ุงูุฌูุงุนูุฉ ููุทูุงุจ ุบูุฑ ุงููุงุนููู
        recommendation = STUDENT_RECOMMENDATIONS["๐ซ Not Utilizing System"]
        
        email_body = f"""
        ุนุฒูุฒุชู ุงููุนููุฉ/ {name}ุ
        
        ุชุญูุฉ ุทูุจุฉ ูุจุนุฏุ
        
        ููุฏ ุชูุจููู ุจูุฌูุฏ ูุฌููุนุฉ ูู ุงูุทูุงุจ ูู ุตูููู ูู ุชุธูุฑ ุจุนุฏ ุงุณุชูุงุฏุฉ ูุงููุฉ ูู ูุธุงู ูุทุฑ ููุชุนูููุ ุญูุซ ุฃู ูุณุจุฉ ุฅูุฌุงุฒูู ุฃูู ูู {inactive_threshold}%.
        
        **ูุงุฆูุฉ ุงูุทูุงุจ ุบูุฑ ุงููุงุนููู:**
        {student_list}
        
        **ุงูุชูุตูุฉ ุงูุชุดุบูููุฉ:**
        {recommendation}
        
        ูุฑุฌู ุงูุชูุงุตู ูุน ูุคูุงุก ุงูุทูุงุจ ูุญุซูู ุนูู ุชูุนูู ุงููุธุงู ูุงููุดุงุฑูุฉ ุงููุดุทุฉ.
        
        ูุน ุฎุงูุต ุงูุดูุฑ ูุงูุชูุฏูุฑุ
        ูุฑูู ุฃู ุฅูุฌุงุฒ
        """
        
        # ููุง ูุชู ุฅุฑุณุงู ุงูุฅูููู ุงููุนูู (ูุฌุจ ุฅุถุงูุฉ ููุฏ SMTP ููุง)
        # ูุซุงู:
        # send_mail(to=email, subject="ุชูุจูู: ุทูุงุจ ุบูุฑ ูุงุนููู ูู ูุธุงู ูุทุฑ ููุชุนููู", body=email_body)
        
        st.write(f"ุชู ุชูููุฏ ุชูุจูู ูููุนููุฉ {name} ({email}) ูู {group.shape[0]} ุทุงูุจ.")

# ---------- Streamlit App ----------
def main():
    
    # 1. ุนุฑุถ ุฑุฃุณ ุงูุตูุญุฉ (ุงูุดุนุงุฑุงุช ูุงูุนููุงู)
    display_header()
    
    # 2. ุฅุนุฏุงุฏุงุช ุงูุดุฑูุท ุงูุฌุงูุจู
    st.sidebar.header("โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุธุงู")
    
    # ูุงุฌูุฉ ุฅุฏุฎุงู ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุงููุณุคูููู
    with st.sidebar.expander("๐ซ ุจูุงูุงุช ุงููุฏุฑุณุฉ ูุงููุณุคูููู", expanded=True):
        st.session_state.school_info = {
            "School_Name": st.text_input("ุงุณู ุงููุฏุฑุณุฉ", "ูุฏุฑุณุฉ ุนุซูุงู ุจู ุนูุงู ุงููููุฐุฌูุฉ"),
            "Coordinator": st.text_input("ููุณู ุงููุดุงุฑูุน ุงูุฅููุชุฑูููุฉ", "ุณุญุฑ ุนุซูุงู"),
            "Academic_Deputy": st.text_input("ุงููุงุฆุจ ุงูุฃูุงุฏููู", "ูุฑูู ุงููุถุน"),
            "Administrative_Deputy": st.text_input("ุงููุงุฆุจ ุงูุฅุฏุงุฑู", "ุฏูุงู ุงููููุฏุฉ"),
            "Principal": st.text_input("ูุฏูุฑ ุงููุฏุฑุณุฉ", "ูููุฑุฉ ุงููุงุฌุฑู"),
        }
    
    # ุฅุนุฏุงุฏุงุช ุงููุธุงู ููุนุงููุฑ ุงูุชุตููู
    with st.sidebar.expander("๐ ูุนุงููุฑ ุงูุชุตููู", expanded=False):
        st.session_state.thresholds = {
            "Platinum": st.number_input("ุญุฏ Platinum (%) (ุฃูุจุฑ ูู)", 0, 100, 89),
            "Gold": st.number_input("ุญุฏ Gold (%) (ุฃูุจุฑ ูู)", 0, 100, 79),
            "Silver": st.number_input("ุญุฏ Silver (%) (ุฃูุจุฑ ูู)", 0, 100, 49),
            "Bronze": st.number_input("ุญุฏ Bronze (%) (ุฃูุจุฑ ูู)", 0, 100, 0)
        }
        inactive_threshold = st.number_input("ุญุฏ ุงูุทูุงุจ ุบูุฑ ุงููุงุนููู (%) (ุฃูู ูู ุฃู ูุณุงูู)", 0, 100, 10)
    
    # 3. ุชุญููู ูููุงุช ุงููุนูููู
    teacher_file = st.sidebar.file_uploader("๐ ุชุญููู ููู ุจูุงูุงุช ุงููุนูููู (ูุฅุฑุณุงู ุงูุฅููููุงุช)", type=["xlsx", "csv", "xls"])
    teachers_df = _load_teachers_df(teacher_file)
    
    # 4. ุชุญููู ูููุงุช ุงูุชููููุงุช
    st.sidebar.header("๐ ุชุญููู ุจูุงูุงุช ุงูุชููููุงุช")
    date_filter = st.sidebar.date_input("ููุชุฑ ุงูุชุงุฑูุฎ (ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุฅูุฌุงุฒ)", pd.to_datetime("today") - pd.Timedelta(days=30))
    uploaded_files = st.sidebar.file_uploader("ุชุญููู ูููุงุช ุงูุชููููุงุช (Excel)", type=["xlsx", "xls"], accept_multiple_files=True)
    
    # 5. ูุนุงูุฌุฉ ุงูุจูุงูุงุช
    if uploaded_files:
        all_rows = []
        for file in uploaded_files:
            try:
                xls = pd.ExcelFile(file)
                selected_sheets = st.sidebar.multiselect(f"ุงุฎุชุฑ ุฃูุฑุงู ูู {file.name}", xls.sheet_names, default=xls.sheet_names)
                
                # ุงููุนุงูุฌุฉ ุงููุนููุฉ
                rows = process_excel_file(file, file.name, start_row_students=1, selected_sheets=selected_sheets)
                all_rows.extend(rows)
                
            except Exception as e:
                st.error(f"ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูููู {file.name}: {e}")
                
        if all_rows:
            raw_df = pd.DataFrame(all_rows)
            raw_df = ensure_uid(raw_df)
            
            # ุชุทุจูู ููุชุฑ ุงูุชุงุฑูุฎ (ุงูุชุฑุงุถูุงูุ ูุง ููุฌุฏ ุนููุฏ ุชุงุฑูุฎุ ูุฐุง ุณููุชุฑุถ ุฃู ุงูููุชุฑ ูุทุจู ูุฏููุงู)
            # if 'date_column' in raw_df.columns:
            #     raw_df = raw_df[pd.to_datetime(raw_df['date_column']) >= date_filter]
                
            summary_df, subjects = build_summary_pivot(raw_df, st.session_state.thresholds)
            
            # ุฑุจุท ุจูุงูุงุช ุงููุนูููู
            if teachers_df is not None and not teachers_df.empty:
                summary_df['class_section'] = summary_df['ุงูุตู'].astype(str) + ' ' + summary_df['ุงูุดุนุจุฉ'].astype(str)
                summary_df = pd.merge(summary_df, teachers_df, on='class_section', how='left')
                summary_df.drop(columns=['class_section'], inplace=True)
            
            st.session_state.summary_df = summary_df
            st.session_state.subjects = subjects
            st.session_state.raw_df = raw_df
            
            st.success(f"ุชูุช ูุนุงูุฌุฉ {summary_df.shape[0]} ุทุงูุจ. ุฅุฌูุงูู ุงูููุงุฏ: {len(subjects)}")
            
            # 6. ุนุฑุถ ุฌุฏูู ุงูููุฎุต
            st.header("ุฌุฏูู ููุฎุต ุฅูุฌุงุฒ ุงูุทูุงุจ")
            st.dataframe(summary_df)
            
            # 7. ุงูุชูุตูุงุช ุนูู ูุณุชูู ุงููุงุฏุฉ
            st.header("ุชุญููู ุงูุฃููุงุท ูุงูุชูุตูุงุช ุนูู ูุณุชูู ุงููุงุฏุฉ")
            for subj in subjects:
                with st.expander(f"ุชูุตูุฉ ุงููุงุฏุฉ: {subj}"):
                    st.info(analyze_subject_patterns(summary_df, subj))
            
            # 8. ุชูุงุฑูุฑ ุงูุทูุงุจ ุงููุฑุฏูุฉ (PDF)
            st.header("๐ ุชูุงุฑูุฑ ุงูุทูุงุจ ุงููุฑุฏูุฉ")
            if not summary_df.empty:
                student_names = summary_df["ุงุณู ุงูุทุงูุจ"].tolist()
                selected_student = st.selectbox("ุงุฎุชุฑ ุทุงูุจูุง ูุฅูุดุงุก ุชูุฑูุฑ ูุฑุฏู:", student_names)
                
                if selected_student:
                    student_data = summary_df[summary_df["ุงุณู ุงูุทุงูุจ"] == selected_student].iloc[0]
                    
                    # ุฎูุงุฑ ุงูุชูุตูุฉ ุงููุฎุตุตุฉ
                    custom_rec = st.text_area(
                        "ุชูุตูุฉ ููุณู ุงููุดุงุฑูุน (ุงุฎุชูุงุฑูุ ุงุชุฑููุง ูุงุฑุบุฉ ูุงุณุชุฎุฏุงู ุงูุชูุตูุฉ ุงูุชููุงุฆูุฉ):",
                        value="",
                        height=100
                    )
                    
                    # ุฅูุดุงุก ุงูุชูุฑูุฑ ุงููุฑุฏู
                    pdf_output = create_student_report_pdf(student_data, raw_df, st.session_state.school_info, custom_rec)
                    
                    st.download_button(
                        label=f"โฌ๏ธ ุชุญููู ุชูุฑูุฑ {selected_student} (PDF)",
                        data=pdf_output,
                        file_name=f"ุชูุฑูุฑ_ุฅูุฌุงุฒ_{selected_student}.pdf",
                        mime="application/pdf"
                    )
                    
                # ุฒุฑ ุชุญููู ุฌููุน ุงูุชูุงุฑูุฑ (ZIP)
                if st.button("โฌ๏ธ ุชุญููู ุฌููุน ุงูุชูุงุฑูุฑ ุงููุฑุฏูุฉ (ZIP)"):
                    with st.spinner("ุฌุงุฑู ุชุฌููุน ุฌููุน ุงูุชูุงุฑูุฑ ุงููุฑุฏูุฉ..."):
                        zip_buffer = BytesIO()
                        with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED, False) as zip_file:
                            for index, row in summary_df.iterrows():
                                pdf_data = create_student_report_pdf(row, raw_df, st.session_state.school_info)
                                zip_file.writestr(f"ุชูุฑูุฑ_ุฅูุฌุงุฒ_{row['ุงุณู ุงูุทุงูุจ']}.pdf", pdf_data.getvalue())
                        
                        st.download_button(
                            label="ุชุญููู ููู ZIP ูุฌููุน ุงูุชูุงุฑูุฑ",
                            data=zip_buffer.getvalue(),
                            file_name="ุฌููุน_ุชูุงุฑูุฑ_ุงูุฅูุฌุงุฒ_ุงููุฑุฏูุฉ.zip",
                            mime="application/zip"
                        )

            # 9. ุงูุชูุฑูุฑ ุงูููู ุงููุตูู (Excel)
            st.header("๐ ุงูุชูุฑูุฑ ุงูููู ุงููุตูู")
            quantitative_excel = create_quantitative_report_excel(summary_df, subjects)
            
            st.download_button(
                label="โฌ๏ธ ุชุญููู ุงูุชูุฑูุฑ ุงูููู ุงููุตูู (Excel)",
                data=quantitative_excel,
                file_name="ุงูุชูุฑูุฑ_ุงูููู_ุงููุตูู_ููุฅูุฌุงุฒ.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
            
            # 10. ุฎูุงุฑุงุช ุงูุชุตุฏูุฑ ูุงูุฅูููู
            st.header("ุฅุฌุฑุงุกุงุช ุฅุถุงููุฉ")
            col_export, col_email = st.columns(2)
            
            with col_export:
                # ุชุตุฏูุฑ Excel
                excel_data = to_excel_bytes({"ููุฎุต ุงูุฅูุฌุงุฒ": summary_df})
                st.download_button(
                    label="โฌ๏ธ ุชุตุฏูุฑ ููุฎุต ุงูุฅูุฌุงุฒ (Excel)",
                    data=excel_data,
                    file_name="ููุฎุต_ุฅูุฌุงุฒ_ุงูุทูุงุจ_ุงููุญุฏุซ.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
            
            with col_email:
                # ุฅุฑุณุงู ุงูุฅููููุงุช
                if st.button("๐ง ุฅุฑุณุงู ุชูุจููุงุช ุงูุทูุงุจ ุบูุฑ ุงููุงุนููู ูููุนูููู"):
                    send_teacher_emails(summary_df, inactive_threshold)
                    st.success("ุชู ุงูุงูุชูุงุก ูู ุนูููุฉ ุชูููุฏ ุงูุชูุจููุงุช.")
        else:
            st.warning("ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ุตุงูุญุฉ ูููุนุงูุฌุฉ.")
    else:
        st.info("ุงูุฑุฌุงุก ุชุญููู ูููุงุช ุงูุชููููุงุช ููุจุฏุก ุจุงูุชุญููู.")
    
    st.markdown(FOOTER_MARKDOWN, unsafe_allow_html=True)

if __name__ == "__main__":
    main()
student_performance_app_full.py
Code ยท 34.48 KB

View all files in this task
Task completed
How was this result?
Suggested follow-ups
Send message to Manus
student_performance_app_full.py
# -*- coding: utf-8 -*-
"""
๐ ุฃู ุฅูุฌุงุฒ โ ููุญุฉ ุชุญููู ุฅูุฌุงุฒ ุงูุทูุงุจ (Purple/White)
- ุงุฎุชูุงุฑ ุฃูุฑุงู Excel ูู ุงูุดุฑูุท ุงูุฌุงูุจู
- ุฑุจุท ุณุฌู ุงูููุฏ (ุฑูู ุดุฎุตู + ุตู + ุดุนุจุฉ) ุจุชุทุจูุน ุงูุงุณู
- ensure_uid: uid ููุญูุฏ + ุฅุฒุงูุฉ ุงูุชูุฑุงุฑุงุช
- Pivot: ูู ุทุงูุจ ุตู ูุงุญุฏ
- ุฑุณูู ุนุงูุฉ + ูุฆุงุช + ููุงุฏ
- ุชูุตูุงุช ุชุดุบูููุฉ ูุฑูุน ูุณุจุฉ ุงูุฅูุฌุงุฒ (ุบูุฑ ุฃูุงุฏูููุฉ)
- ุชุตุฏูุฑ Excel ุดุงูู + PDF ูุฑุฏู ููู ุทุงูุจ ุฏุงุฎู ZIP
- ุญูุธ ุงูุฌุฏุงูู ูู session_state ูุซุจุงุช ุฃุฒุฑุงุฑ ุงูุชุตุฏูุฑ
- ููุฒุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ุชุญููู ุงูุฃููุงุทุ ูุงูุชูุตูุงุช ุงููุฎุตุตุฉ ุจุงุณุชุฎุฏุงู LLM
"""

import streamlit as st
import pandas as pd
import plotly.express as px
from io import BytesIO
import re, zipfile
from typing import Dict, List, Tuple, Optional
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib.colors import Color
from reportlab.lib.units import mm
from reportlab.lib.utils import ImageReader
import openai # ูุงุณุชุฎุฏุงู ููุฒุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู

# ุชููุฆุฉ ุนููู OpenAI (ูุณุชุฎุฏู ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ ุชููุงุฆููุง)
try:
    client = openai.OpenAI()
except Exception as e:
    # st.error(f"ูุดู ุชููุฆุฉ ุนููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู: {e}. ูุฏ ูุง ุชุนูู ููุฒุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู.")
    client = None

# --------------- ุฅุนุฏุงุฏ ุงูุตูุญุฉ ---------------
st.set_page_config(page_title="ุฃู ุฅูุฌุงุฒ", page_icon="๐", layout="wide")

POSITIVE_STATUS = ["solved","yes","1","ุชู","ููุฌุฒ","โ","โ","โ"]
NEGATIVE_STATUS = ["no","0","ุบูุฑ ููุฌุฒ","ูู ูุญู","ุฎุทุฃ"]

# --------------- ุงูุชูุตูุงุช ุงูุซุงุจุชุฉ ุงูุฌุฏูุฏุฉ (ุนูู ูุณุชูู ุงูุทุงูุจ) ---------------
STUDENT_RECOMMENDATIONS = {
    "๐ Platinum": "ูุซูู ุชููุฒู ุงููุณุชูุฑุ ููุฏ ุฃุธูุฑุช ุฅุจุฏุงุนูุง ูุงุฌุชูุงุฏูุง ููุญูุธูุง. ุงุณุชูุฑ ูู ุงุณุชุฎุฏุงู ูุธุงู ูุทุฑ ููุชุนููู ุจูุนุงููุฉุ ูุฃูุช ูููุฐุฌ ูุญุชุฐู ุจู.",
    "๐ฅ Gold": "ุฃุญุณูุช! ูุณุชูุงู ูุนูุณ ุงูุชุฒุงููุง ุฑุงุฆุนูุงุ ูุซู ุฃูู ุจูุชุงุจุนุฉ ุงูุฌูุฏ ุณุชูุชูู ููุณุชูู ุฃุนูู. ุงุณุชูุฑ ูู ุชูุนูู ูุธุงู ูุทุฑ ุฏุงุฎู ุงูุตู.",
    "๐ฅ Silver": "ุนููู ุฌูุฏ ููุณุชุญู ุงูุชูุฏูุฑุ ููุน ูุฒูุฏ ูู ุงูููุงุฑุณุฉ ูุงูุชูุงุนู ูุน ูุธุงู ูุทุฑ ุณุชุตู ุฅูู ูุณุชููุงุช ุฃุฑูุน. ูุญู ูุฎูุฑูู ุจู.",
    "๐ฅ Bronze": "ููุฏ ุฃุธูุฑุช ุฌูุฏูุง ูุดููุฑูุงุ ููุดุฌุนู ุนูู ุจุฐู ุงููุฒูุฏ ูู ุงูุนุทุงุก. ุจุงุณุชุฎุฏุงู ูุธุงู ูุทุฑ ุจุดูู ุฃุนูู ุณุชุชุทูุฑ ูุฏุฑุงุชู ุจุดูู ุฃูุจุฑ.",
    "๐ง Needs Improvement": "ูุฑู ูุฏูู ุฅููุงููุงุช ูุงุนุฏุฉุ ููู ุชุญุชุงุฌ ููุฒูุฏ ูู ุงูุงูุชุฒุงู ุจุงุณุชุฎุฏุงู ูุธุงู ูุทุฑ ููุชุนููู. ููุตูู ุจุงููุซุงุจุฑุฉ ูุงููุดุงุฑูุฉ ุงููุดุทุฉุ ููุญู ุจุฌุงูุจู ูุชุชูุฏู.",
    "๐ซ Not Utilizing System": "ูู ูุธูุฑ ุจุนุฏ ุงุณุชูุงุฏุฉ ูุงููุฉ ูู ูุธุงู ูุทุฑ ููุชุนูููุ ููุฏุนูู ุฅูู ุชูุนูู ุงููุธุงู ุจุดูู ุฃูุจุฑ ูุชุญููู ุงููุฌุงุญ. ูุญู ูุซู ุฃู ูุฏูู ุงููุฏุฑุฉ ุนูู ุงูุชุบููุฑ ูุงูุชููุฒ."
}

# --------------- ุฃุฏูุงุช ูุณุงุนุฏุฉ ---------------
def _strip_invisible_and_diacritics(s: str) -> str:
    # ุฅุฒุงูุฉ ุงูุฃุญุฑู ุบูุฑ ุงููุฑุฆูุฉ ูุงูุชุดููู
    s = re.sub(r"[\u200b-\u200f\u202a-\u202e\u064b-\u0652\u0640]", "", s)
    return s

def _normalize_arabic_digits(s: str) -> str:
    # ุชุญููู ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ ุฅูู ููุฏูุฉ (ูุงุชูููุฉ) ูุชูุญูุฏ ุงูุตููู ูุงูุดุนุจ
    s = str(s).replace("ู", "0").replace("ูก", "1").replace("ูข", "2").replace("ูฃ", "3")
    s = s.replace("ูค", "4").replace("ูฅ", "5").replace("ูฆ", "6").replace("ูง", "7")
    s = s.replace("ูจ", "8").replace("ูฉ", "9")
    return s

def arabic_cleanup(s: str) -> str:
    if pd.isna(s): return ""
    return re.sub(r"\s+"," ",str(s).strip())

def normalize_name(s: str) -> str:
    s = arabic_cleanup(s)
    s = _strip_invisible_and_diacritics(s)
    s = s.replace("ุฃ","ุง").replace("ุฅ","ุง").replace("ุข","ุง")
    return s

def normalize_status(val) -> int:
    if pd.isna(val): return 0
    try:
        return 1 if float(str(val)) > 0 else 0
    except:
        return 1 if str(val).lower() in POSITIVE_STATUS else 0

def parse_sheet_subject(sheet_name: str) -> Tuple[str,str,str]:
    name = arabic_cleanup(sheet_name); grade=""; section=""
    # ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ (ุงููุงุฏุฉ) (ุงูุตู) (ุงูุดุนุจุฉ)
    m = re.search(r"(.+?)\s+(\d{1,2})\s+([A-Za-z0-9]+)\s*$", name)
    if m:
        # ุชูุญูุฏ ุชูุณูู ุงูุตู ููููู ุฑูููู (ูุซู 07)
        grade_num = int(m.group(2))
        grade = f"ุงููุณุชูู {grade_num:02d}"
        return arabic_cleanup(m.group(1)), grade, m.group(3)
    return name, grade, section

def detect_header_row(df: pd.DataFrame, default_header_row: int) -> int:
    hr = default_header_row if default_header_row < len(df) else 0
    if df.iloc[hr].notna().sum() <= 1 and len(df)>0:
        if df.iloc[0].notna().sum() > 1: hr = 0
    return hr

def process_excel_file(file_obj, file_name, start_row_students: int,
                       selected_sheets: Optional[List[str]]=None) -> List[Dict]:
    rows = []
    try:
        xls = pd.ExcelFile(file_obj)
    except Exception as e:
        st.error(f"ุชุนุฐูุฑ ูุชุญ {file_name}: {e}")
        return rows
    sheets = xls.sheet_names if not selected_sheets else [s for s in xls.sheet_names if s in selected_sheets]
    for sh in sheets:
        try:
            raw = pd.read_excel(xls, sheet_name=sh, header=None)
            if raw.empty:
                st.warning(f"ุงูุดูุช '{sh}' ูุงุฑุบ ูู {file_name}"); continue
            hr = detect_header_row(raw, max(0, start_row_students-3))
            header = [arabic_cleanup(x) for x in raw.iloc[hr].tolist()]
            eval_cols = {idx:title for idx,title in enumerate(header) if idx>0 and title}
            subject, grade, section = parse_sheet_subject(sh)
            first_row = max(start_row_students, hr+1)
            for r in range(first_row, len(raw)):
                row = raw.iloc[r]
                student_name = arabic_cleanup(row[0]) if 0 in raw.columns else ""
                if len(student_name) < 2: continue
                for c_idx, eval_name in eval_cols.items():
                    if c_idx < len(row):
                        solved = normalize_status(row[c_idx])
                        rows.append({
                            "student_name": student_name,
                            "student_name_norm": normalize_name(student_name),
                            "student_id": "", # ูููุชุฑุถ ุฃู ูููู ูู ุงูุนููุฏ 1 ุฅุฐุง ูุฌุฏ
                            "subject": subject,
                            "evaluation": eval_name,
                            "solved": int(solved),
                            "class": grade,
                            "section": section,
                            "teacher_email": "" # ุณูุชู ููุคู ูุงุญููุง
                        })
        except Exception as e:
            st.warning(f"ุชุนุฐูุฑ ูุฑุงุกุฉ '{sh}' ูู {file_name}: {e}")
    return rows

def _load_teachers_df(file) -> Optional[pd.DataFrame]:
    """ูุฑูุน ููู ุงููุนููุงุช ููุนูุฏ DataFrame ููุญูุฏ ุงูุฃุนูุฏุฉ: ุงูุดุนุจุฉุ ุงุณู ุงููุนููุฉุ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
       ูุฏุนู CSV ูXLSX."""
    if file is None:
        return None

    name = file.name.lower()

    # 1) ูุฑุงุกุฉ ุงูููู ุญุณุจ ุงูุงูุชุฏุงุฏ
    try:
        if name.endswith(".csv"):
            tdf = pd.read_csv(file)
        elif name.endswith(".xlsx"):
            tdf = pd.read_excel(file, engine="openpyxl")
        elif name.endswith(".xls"):
            # ูุญุงูู xlrd .. ูุฅู ูู ุชูุฌุฏ ูุทูุจ ูู ุงููุณุชุฎุฏู ุงูุชุญููู
            try:
                import xlrd  # noqa: F401
                tdf = pd.read_excel(file, engine="xlrd")
            except Exception:
                st.error(
                    "ูุฐุง ุงูููู ุจุตูุบุฉ .xls ููุชุทูุจ ุญุฒูุฉ xlrd ุบูุฑ ูุชููุฑุฉ.\n"
                    "ูุถูุงู ุงุญูุธู ุงูููู ูู **.xlsx** ุฃู **.csv** ุซู ุงุฑูุนูู ูุฌุฏุฏูุง."
                )
                return None
        else:
            st.error("ุตูุบุฉ ุงูููู ุบูุฑ ูุฏุนููุฉ. ุงุฑูุนู ููููุง ุจุตูุบุฉ **CSV** ุฃู **XLSX**.")
            return None
    except Exception as e:
        st.error(f"โ ูุฑุงุกุฉ ููู ุงููุนููุงุช ูุดูุช: {e}")
        return None

    # 2) ุชูุญูุฏ ุฃุณูุงุก ุงูุฃุนูุฏุฉ (ูุฑู ูุน ุงูุงุฎุชูุงูุงุช)
    def _norm_header(x: str) -> str:
        x = _strip_invisible_and_diacritics(str(x)).lower()
        x = x.replace("ุฃ","ุง").replace("ุฅ","ุง").replace("ุข","ุง").replace("ุฉ","ู")
        # ุฅุฒุงูุฉ ูู ุงูุฑููุฒ ุบูุฑ ุงูุญุฑูู/ุงูุฃุฑูุงู ูุชุณููู ุงููุทุงุจูุฉ
        return re.sub(r"[^0-9a-z\u0600-\u06FF]+", "", x)

    cols_map = {c: _norm_header(c) for c in tdf.columns}

    def find_col(possible_keys: List[str]) -> Optional[str]:
        norm_keys = [_norm_header(k) for k in possible_keys]
        for original, normed in cols_map.items():
            if normed in norm_keys:
                return original
        return None

    # ุชู ุชุนุฏูู ููุงุชูุญ ุงูุจุญุซ ูุชููู ุฃูุซุฑ ุดูููุงู
    sec_col  = find_col(["ุงูุดุนุจุฉ", "ุดุนุจุฉ", "section", "ุงููุณู", "ุตู", "ุงูุตู", "ุงูุตู ูุงูุดุนุจุฉ"])
    name_col = find_col(["ุงุณู ุงููุนููุฉ", "ุงููุนููุฉ", "Teacher", "teacher",
                         "ุงุณู ุงููุนูู", "ุงููุนูู", "ุงุณู ุงููุนููู", "ุงููุนูู ุงููุณุคูู"])
    mail_col = find_col(["ุงูุจุฑูุฏ ุงูุฅููุชุฑููู", "ุงูุจุฑูุฏ ุงูุงููุชุฑููู", "ุงูุจุฑูุฏ",
                         "email", "e-mail", "ุงูููู", "ุงูุงูููู", "ุจุฑูุฏ ุงููุนูู"])

    if not (sec_col and name_col and mail_col):
        st.error("โ ูุฌุจ ุฃู ูุญุชูู ุงูููู ุนูู ุฃุนูุฏุฉ: **ุงูุดุนุจุฉ**ุ **ุงุณู ุงููุนููุฉ**ุ **ุงูุจุฑูุฏ ุงูุฅููุชุฑููู**.")
        with st.expander("ุงูุฃุนูุฏุฉ ุงูุชู ุชู ุงูุชุดุงููุง"):
            st.write(list(tdf.columns))
        return None

    tdf = tdf[[sec_col, name_col, mail_col]].rename(columns={
        sec_col:  "ุงูุดุนุจุฉ",
        name_col: "ุงุณู ุงููุนููุฉ",
        mail_col: "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"
    })

    # 3) ุชูุธูู ุงูููู
    tdf["ุงูุดุนุจุฉ"] = (tdf["ุงูุดุนุจุฉ"].astype(str)
                      .apply(_strip_invisible_and_diacritics)
                      .map(_normalize_arabic_digits)
                      .str.strip())
    tdf["ุงุณู ุงููุนููุฉ"]      = tdf["ุงุณู ุงููุนููุฉ"].astype(str).str.strip()
    tdf["ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"] = tdf["ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"].astype(str).str.strip()

    return tdf

# --------- ุฃูู ุฑูุนุฉ: ุถูุงู uid ุฏุงุฆููุง ---------
def ensure_uid(df: pd.DataFrame) -> pd.DataFrame:
    """ูุถูู ูุฌูุฏ uidุ ูุชูุญูุฏ ุงูุตู/ุงูุดุนุจุฉุ ูุฅุฒุงูุฉ ุงูุชูุฑุงุฑ ุงูุฃุณุงุณู."""
    if "student_name_norm" not in df.columns:
        df["student_name_norm"] = df.get("student_name", "").astype(str).apply(normalize_name)

    df["student_id"] = df.get("student_id", "").fillna("").astype(str).str.strip()
    uid = df["student_id"].copy()
    mask = (uid == "")
    uid[mask] = df.loc[mask, "student_name_norm"].astype(str)
    df["uid"] = uid

    df["class"]   = df.get("class","").fillna("").astype(str).str.strip()
    df["section"] = df.get("section","").fillna("").astype(str).str.strip()
    # ุชูุญูุฏ ุชูุณูู ุงูุตู ููููู ุฑูููู (ูุซู 07)
    df["class"] = df["class"].str.replace(r"ุงููุณุชูู\s*(\d)", r"ุงููุณุชูู 0\1", regex=True)

    # ุฅุฒุงูุฉ ุชูุฑุงุฑ ููุณ (uid, subject, evaluation)
    if {"subject","evaluation","solved"}.issubset(df.columns):
        df = (df.sort_values(["uid","subject","evaluation","solved"],
                             ascending=[True,True,True,False])
                .drop_duplicates(subset=["uid","subject","evaluation"], keep="first"))
    return df

# --------- Pivot/ููุฎุต ูุนุชูุฏ uid ---------
def build_summary_pivot(df: pd.DataFrame, teachers_df: Optional[pd.DataFrame], thresholds: Dict[str,int]):
    if df.empty:
        return pd.DataFrame(), []
    
    # 1. ุชุฃููุฏ uid
    if "uid" not in df.columns:
        df = ensure_uid(df.copy())

    # 2. ุฅุฌูุงููุงุช ููู (uid/ูุงุฏุฉ)
    grp = (df.groupby(["uid","subject"], dropna=False)
             .agg(solved=("solved","sum"), total=("solved","count"))
             .reset_index())
    subjects = sorted(grp["subject"].dropna().unique().tolist())

    # 3. Pivot Table (ุฅุตูุงุญ ูุดููุฉ KeyError: 'uid')
    piv = grp.pivot_table(index=["uid"], columns="subject",
                          values=["solved","total"], fill_value=0, aggfunc="sum").reset_index()
    
    # ุฅุตูุงุญ ุชุณููุฉ ุงูุฃุนูุฏุฉ ุจุนุฏ pivot_table
    new_columns = []
    for met, subj in piv.columns:
        if subj == "":
            new_columns.append("uid")
        else:
            new_columns.append(f"{subj}_{met}")
    piv.columns = new_columns

    # 4. ุฏูุฌ ุงูุจูุงูุงุช ุงููุตููุฉ (ุงุณู ุงูุทุงูุจุ ุงูุตูุ ุงูุดุนุจุฉ)
    meta = (df.sort_values(["uid"])
              .groupby("uid", as_index=False)
              .agg(student_name=("student_name","first"),
                   student_id=("student_id","first"),
                   classx=("class","first"),
                   sectionx=("section","first")))

    piv = meta.merge(piv, on="uid", how="left")

    # 5. ุญุณุงุจ ุงูุฅูุฌุงุฒ ุงูุนุงู ูุงูุชุตููู
    solved_cols = [c for c in piv.columns if str(c).endswith("_solved")]
    total_cols  = [c for c in piv.columns if str(c).endswith("_total")]
    piv["Overall_Solved"] = piv[solved_cols].sum(axis=1) if solved_cols else 0
    piv["Overall_Total"]  = piv[total_cols].sum(axis=1)  if total_cols else 0
    piv["Overall_Completion"] = (piv["Overall_Solved"]/piv["Overall_Total"]*100).fillna(0).round(2)

    # *****************************************************************
    # ุชุนุฏูู ุฏุงูุฉ ุงูุชุตููู ูุชุชูุงูู ูุน ุงููุนุงููุฑ ุงูุฌุฏูุฏุฉ (ุฃูุจุฑ ูู)
    # *****************************************************************
    def cat(x):
        if x == 0:
            return "๐ซ Not Utilizing System"
        elif x > thresholds["Platinum"]:
            return "๐ Platinum"
        elif x > thresholds["Gold"]:
            return "๐ฅ Gold"
        elif x > thresholds["Silver"]:
            return "๐ฅ Silver"
        elif x > thresholds["Bronze"]:
            return "๐ฅ Bronze"
        else:
            return "๐ง Needs Improvement" # ูุณุจุฉ ุฅูุฌุงุฒ > 0 ูููููุง ูู ุชุตู ูุนุชุจุฉ ุงูุจุฑููุฒู
    piv["Category"] = piv["Overall_Completion"].apply(cat)
    # *****************************************************************

    # 6. ุฏูุฌ ุจูุงูุงุช ุงููุนูููู (ุฅุฐุง ุชููุฑุช)
    if teachers_df is not None:
        # ุฅูุดุงุก ุนููุฏ ูููุทุงุจูุฉ (ุงูุตู ูุงูุดุนุจุฉ)
        piv["merge_key"] = piv["classx"] + " " + piv["sectionx"]
        teachers_df["merge_key"] = teachers_df["ุงูุดุนุจุฉ"]
        
        # ุฏูุฌ ุจูุงูุงุช ุงููุนูููู
        piv = piv.merge(teachers_df[["merge_key", "ุงุณู ุงููุนููุฉ", "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"]], 
                        left_on="merge_key", right_on="merge_key", how="left").drop(columns=["merge_key"])
        
        # ุฅุถุงูุฉ ุนููุฏ ุจุฑูุฏ ุงููุนูู ููู ูุงุฏุฉ (ุงูุชุฑุงุถูุง ุฃู ุงููุนูู ูู ููุณู ููู ุงูููุงุฏ ูู ุงูุดุนุจุฉ)
        piv["teacher_email"] = piv["ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"].fillna("")
        piv["teacher_name"] = piv["ุงุณู ุงููุนููุฉ"].fillna("")
    else:
        piv["teacher_email"] = ""
        piv["teacher_name"] = ""

    # 7. ุงูุชูุตูุงุช ุงูุชุดุบูููุฉ (ุงูุซุงุจุชุฉ)
    piv["Student_Recommendation"] = piv["Category"].apply(lambda x: STUDENT_RECOMMENDATIONS.get(x, STUDENT_RECOMMENDATIONS["๐ง Needs Improvement"]))

    # 8. ุฅุนุงุฏุฉ ุชุณููุฉ ุงูุฃุนูุฏุฉ ุงูููุงุฆูุฉ
    out = piv.rename(columns={
        "student_name":"ุงุณู ุงูุทุงูุจ", "student_id":"ุงูุฑูู ุงูุดุฎุตู",
        "classx":"ุงูุตู", "ุงูุดุนุจุฉ":"ุงูุดุนุจุฉ",
        "Overall_Total":"ุฅุฌูุงูู ุงูุชููููุงุช",
        "Overall_Solved":"ุงูููุฌุฒ",
        "Overall_Completion":"ูุณุจุฉ ุงูุฅูุฌุงุฒ %",
        "Category":"ุงููุฆุฉ",
        "teacher_name": "ุงุณู ุงููุนููุฉ",
        "teacher_email": "ุจุฑูุฏ ุงููุนููุฉ",
        "Student_Recommendation": "ุชูุตูุฉ ุงูุทุงูุจ"
    })

    # 9. pending ููู ูุงุฏุฉ + ุชูุธูู ุฃุณูุงุก ุงูุฃุนูุฏุฉ
    for subj in subjects:
        t=f"{subj}_total"; s=f"{subj}_solved"
        if t in out.columns and s in out.columns:
            out[f"{subj}_pending"] = (out[t]-out[s]).clip(lower=0)
    out.columns = out.columns.astype(str).str.strip()

    base = ["ุงุณู ุงูุทุงูุจ","ุงูุฑูู ุงูุดุฎุตู","ุงูุตู","ุงูุดุนุจุฉ","ุงุณู ุงููุนููุฉ","ุจุฑูุฏ ุงููุนููุฉ",
            "ุฅุฌูุงูู ุงูุชููููุงุช","ุงูููุฌุฒ","ูุณุจุฉ ุงูุฅูุฌุงุฒ %","ุงููุฆุฉ", "ุชูุตูุฉ ุงูุทุงูุจ"]
    others = [c for c in out.columns if c not in base and c != "uid"]
    out = out[base + others]
    return out, subjects

# --------- ููุฒุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ุงูุชูุตูุงุช ุงููุฎุตุตุฉ (ุชู ุฅุฒุงูุชูุง ูุงุณุชุจุฏุงููุง ุจุงูุซุงุจุชุฉ) ---------
# @st.cache_data(show_spinner="ุฌุงุฑู ุชูููุฏ ุงูุชูุตูุงุช ุงูุฐููุฉ...")
# def generate_ai_recommendation(row: pd.Series, subjects: List[str]) -> str:
#     ...

# --------- ุฏุงูุฉ ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ---------
def send_teacher_emails(summary_df: pd.DataFrame, inactive_threshold: float = 10.0):
    if not st.session_state.get("smtp_configured", False):
        st.warning("ูู ูุชู ุฅุนุฏุงุฏ ุจูุงูุงุช ุฎุงุฏู SMTP. ูุง ูููู ุฅุฑุณุงู ุงูุฅููููุงุช.")
        return False
    
    # ุชุญุฏูุฏ ุงูุทูุงุจ ุบูุฑ ุงููุงุนููู (ุฃูู ูู ูุณุจุฉ ุฅูุฌุงุฒ ูุนููุฉ)
    inactive_students = summary_df[summary_df["ูุณุจุฉ ุงูุฅูุฌุงุฒ %"] < inactive_threshold]
    
    if inactive_students.empty:
        st.info("ูุง ููุฌุฏ ุทูุงุจ ุบูุฑ ูุงุนููู ูุฅุฑุณุงู ุชูุจููุงุช ุจุดุฃููู.")
        return True

    # ุงูุชุฌููุน ุญุณุจ ุงููุนูู ูุงูุจุฑูุฏ ุงูุฅููุชุฑููู
    teacher_groups = inactive_students.groupby(["ุจุฑูุฏ ุงููุนููุฉ", "ุงุณู ุงููุนููุฉ"])
    
    for (email, teacher_name), group in teacher_groups:
        if not email or email == "nan":
            st.warning(f"ุชุฌุงูู ุฅุฑุณุงู ุชูุจููุงุช ูู {teacher_name}: ูุง ููุฌุฏ ุจุฑูุฏ ุฅููุชุฑููู ูุณุฌู.")
            continue
        
        # ุจูุงุก ูุญุชูู ุงูุฅูููู
        student_list = "\n".join([f"- {row['ุงุณู ุงูุทุงูุจ']} (ูุณุจุฉ ุงูุฅูุฌุงุฒ: {row['ูุณุจุฉ ุงูุฅูุฌุงุฒ %']:.1f}%)" 
                                  for index, row in group.iterrows()])
        
        subject = f"ุชูุจูู: ุทูุงุจ ุบูุฑ ูุงุนููู ูู ุงูุดุนุจุฉ {group['ุงูุดุนุจุฉ'].iloc[0]}"
        body = f"""
        ุนุฒูุฒุชู ุงููุนููุฉ {teacher_name}ุ
        
        ุชุญูุฉ ุทูุจุฉ ูุจุนุฏุ
        
        ููุฏ ุชูุจููู ุจูุฌูุฏ ูุฌููุนุฉ ูู ุงูุทูุงุจ ูู ุดุนุจุชู ูู ุชุชุฌุงูุฒ ูุณุจุฉ ุฅูุฌุงุฒูู {inactive_threshold:.1f}% ูู ุงูุชููููุงุช ุงูุฃุฎูุฑุฉ.
        
        **ูุงุฆูุฉ ุงูุทูุงุจ ุบูุฑ ุงููุงุนููู:**
        {student_list}
        
        **ุงูุชูุตูุฉ ุงูุชุดุบูููุฉ ุงูุนุงูุฉ:**
        {analyze_teacher_group(group)}
        
        ุงูุฑุฌุงุก ุงูุชูุงุตู ูุน ูุคูุงุก ุงูุทูุงุจ ููุชุงุจุนุชูู ูุฑูุน ูุณุจุฉ ุฅูุฌุงุฒูู.
        
        ุดูุฑุงู ูุฌููุฏูุ
        ูุธุงู ุฃู ุฅูุฌุงุฒ ุงูุขูู
        """
        
        # ููุง ูุชู ุงุณุชุฏุนุงุก ุฏุงูุฉ ุงูุฅุฑุณุงู ุงููุนููุฉ (ูุฌุจ ุฃู ูุชู ุชูููุฐูุง ุฎุงุฑุฌ ูุฐุง ุงูููุฏ)
        # ูุซุงู:
        # try:
        #     _send_email(to=email, subject=subject, body=body)
        #     st.success(f"ุชู ุฅุฑุณุงู ุชูุจูู ุฅูู {teacher_name} ({email}).")
        # except Exception as e:
        #     st.error(f"ูุดู ุฅุฑุณุงู ุงูุฅูููู ุฅูู {teacher_name}: {e}")
        
        st.info(f"ุชู ุชูููุฏ ุชูุจูู ูู {teacher_name} ({email}) ุจุฎุตูุต {len(group)} ุทุงูุจ ุบูุฑ ูุงุนู.")
        
    return True

# --------- ููุฒุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ุชูุตูุฉ ุนูู ูุณุชูู ุงููุนูู (ุงููุฌููุนุฉ) ---------
@st.cache_data(show_spinner="ุฌุงุฑู ุชูููุฏ ุชูุตูุฉ ูููุนูู...")
def analyze_teacher_group(group_df: pd.DataFrame) -> str:
    # ุชู ุฅุฒุงูุฉ ุงูุงุนุชูุงุฏ ุนูู LLM ูุงุณุชุจุฏุงููุง ุจููุทู ุจุณูุท
    avg_completion = group_df["ูุณุจุฉ ุงูุฅูุฌุงุฒ %"].mean()
    
    # ุงุณุชุฎุฏุงู ุงูุชูุตูุงุช ุงูุซุงุจุชุฉ ุนูู ูุณุชูู ุงููุงุฏุฉ (ุงููุฑููุฉ ูู pasted_content_3.txt)
    if avg_completion >= 90:
        return "ุฃุธูุฑ ุทูุงุจ ุงูุตู ุงูุชุฒุงููุง ุนุงูููุง ุจุฅูุฌุงุฒ ุงูุชููููุงุช ุงูุฃุณุจูุนูุฉ ุนูู ูุธุงู ูุทุฑ ููุชุนููู ุจูุณุจุฉ ุชููู 90%. ููุตู ุจุงูุงุณุชูุฑุงุฑ ุนูู ูุฐุง ุงูููุฌ ูุน ุชุฐููุฑ ุงูุทูุงุจ ุฏุงุฆููุง ุจุญู ุงูุชููููุงุช ุจููุงูุฉ ูู ุญุตุฉุ ูุชูุธูู ุงููุธุงู ูู ุฑูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ุงูุตููู ุงูููููุจุฉ ูุฒูุงุฏุฉ ุนูู ุงูููู."
    elif avg_completion >= 75:
        return "ุญูู ุงูุตู ูุณุชูู ุฌูุฏ ุฌุฏูุง ูู ุญู ุงูุชููููุงุช ุงูุฃุณุจูุนูุฉ. ููุชุฑุญ ุชุนุฒูุฒ ูุฐุง ุงูุฃุฏุงุก ุนุจุฑ ุชุฐููุฑ ุงูุทูุงุจ ูู ููุงูุฉ ูู ุญุตุฉ ุจุฅูุฌุงุฒ ุงูุชููููุงุชุ ูุน ุชูุธูู ูุธุงู ูุทุฑ ููุชุนููู ูุฏุนู ุงูุตููู ุงูููููุจุฉ ูุชุทููุฑ ููุงุฑุงุช ุงูุชูููุฑ ุงูุนููุง."
    elif avg_completion >= 60:
        return "ุจูุบ ุงูุตู ูุณุจุฉ ุฅูุฌุงุฒ ูุชูุณุทุฉ ูู ุงูุชููููุงุช ุงูุฃุณุจูุนูุฉ (60โ75%). ููุตู ุจุชูุซูู ุชุฐููุฑ ุงูุทูุงุจ ุจุฅูุฌุงุฒ ุงูุชููููุงุช ูู ููุงูุฉ ูู ุญุตุฉุ ูุชูุนูู ุฏูุฑ ุงููุธุงู ูู ุงูุตููู ุงูููููุจุฉ ูุชุดุฌูุน ุงูุทูุงุจ ุนูู ุงูุชูุงุนู ุงููุณุชูุฑ."
    elif avg_completion >= 40:
        return "ูุณุจุฉ ุงูุญู ูุง ุฒุงูุช ุชุญุชุงุฌ ุฅูู ุชุญุณููุ ุฅุฐ ูู ุชุชุฌุงูุฒ 60%. ููุตู ุจุงูุชุฑููุฒ ุนูู ุชุฐููุฑ ุงูุทูุงุจ ูููููุง ูู ููุงูุฉ ูู ุญุตุฉ ุจุฃูููุฉ ุญู ุงูุชููููุงุชุ ูุน ุฏูุฌ ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุนูู ุงููุดุท ูุฑูููุฉ ุงูุตููู ุงูููููุจุฉ ุจุงุณุชุฎุฏุงู ูุธุงู ูุทุฑ ููุชุนููู."
    elif avg_completion > 0:
        return "ูุณุจุฉ ุงูุฅูุฌุงุฒ ูู ุงูุชููููุงุช ุงูุฃุณุจูุนูุฉ ุถุนููุฉ ุนูู ูุณุชูู ุงูุตู. ููุตู ุจุชูุซูู ุงูุฌููุฏ ุนุจุฑ ุงูุชุฐููุฑ ุงููุณุชูุฑ ุจููุงูุฉ ุงูุญุตุต ุจุฅูุฌุงุฒ ุงูุชููููุงุชุ ูุชุจุณูุท ุงูุชูุงุฑูู ุฏุงุฎู ูุธุงู ูุทุฑ ููุชุนููู ุถูู ุงุณุชุฑุงุชูุฌูุฉ ุงูุตููู ุงูููููุจุฉ ูุฒูุงุฏุฉ ุงูุชูุงุนู."
    else:
        return "ูู ููุฌุฒ ุงูุตู ุฃู ุชูููู ุฃุณุจูุนู ูู ูุฐู ุงููุงุฏุฉ. ููุตู ุจุฅุทูุงู ุฎุทุฉ ุนุงุฌูุฉ ุชุดูู: ุชุฐููุฑ ุงูุทูุงุจ ุจููุงูุฉ ูู ุญุตุฉ ุจุฃูููุฉ ุฅูุฌุงุฒ ุงูุชููููุงุชุ ูุงูุชูุงุตู ูุน ุฃูููุงุก ุงูุฃููุฑุ ูุน ุงุนุชูุงุฏ ูุธุงู ูุทุฑ ููุชุนููู ูููุตุฉ ุฑุฆูุณูุฉ ูุฑูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ุงูุตููู ุงูููููุจุฉ."

# --------- ููุฒุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู: ุชุญููู ุงูุฃููุงุท ุนูู ูุณุชูู ุงููุงุฏุฉ (ุชู ุงุณุชุจุฏุงููุง ุจุงูุซุงุจุชุฉ) ---------
@st.cache_data(show_spinner="ุฌุงุฑู ุชุญููู ุฃููุงุท ุงูุฅูุฌุงุฒ ูููุงุฏุฉ...")
def analyze_subject_patterns(summary_df: pd.DataFrame, subject: str) -> str:
    # ุชุญุฏูุฏ ูุชูุณุท ูุณุจุฉ ุงูุฅูุฌุงุฒ ูููุงุฏุฉ
    total_solved = summary_df[f"{subject}_solved"].sum()
    total_total = summary_df[f"{subject}_total"].sum()
    avg_completion = (total_solved / total_total * 100) if total_total > 0 else 0
    
    # ุงุณุชุฎุฏุงู ุงูุชูุตูุงุช ุงูุซุงุจุชุฉ ุนูู ูุณุชูู ุงููุงุฏุฉ (ุงููุฑููุฉ ูู pasted_content_3.txt)
    if avg_completion >= 90:
        return "ุงููุงุฏุฉ ุญููุช ูุณุจุฉ ุฅูุฌุงุฒ ูุฑุชูุนุฉ ุฌุฏูุง ูู ุงูุชููููุงุช ุงูุฃุณุจูุนูุฉ ุนูู ูุธุงู ูุทุฑ ููุชุนููู. ูููุตู ุจุฏุนู ุงุณุชุฏุงูุฉ ูุฐุง ุงููุณุชูู ุนุจุฑ ุชูุซูู ุฃูุถู ุงูููุงุฑุณุงุช ูุชุนููููุง ุจูู ุงูุตูููุ ูุน ุงูุญุฑุต ุนูู ุงูุชูุงุตู ุงููุณุชูุฑ ูุน ุฃูููุงุก ุงูุฃููุฑ ูุชุนุฒูุฒ ุงูุดุฑุงูุฉ ุงูุชุฑุจููุฉ. ููุง ูููุตู ุจู ุชุฐููุฑ ุงูุทูุงุจ ุฏุงุฆููุง ุจุญู ุงูุชููููุงุช ุจููุงูุฉ ูู ุญุตุฉุ ูุฑูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ุงูุตููู ุงูููููุจุฉ ุจุชูุธูู ูุธุงู ูุทุฑ ููุชุนููู."
    elif avg_completion >= 75:
        return "ุงููุงุฏุฉ ุฃุธูุฑุช ูุณุจุฉ ุฅูุฌุงุฒ ุฌูุฏุฉ ุฌุฏูุง ูุน ูุฑุตุฉ ููุงุฑุชูุงุก ุฅูู ูุณุชูู ุงูุงูุชูุงุฒ. ูููุตู ุจุฒูุงุฏุฉ ุงูุชุญููุฒ ูุงููุชุงุจุนุฉุ ูุงูุชูุงุตู ูุน ุฃูููุงุก ุงูุฃููุฑ ูุฏุนู ุงูุชุธุงู ุงูุทูุงุจุ ูุน ุงูุชุฃููุฏ ุนูู ุชุฐููุฑ ุงูุทูุงุจ ุฏุงุฆููุง ุจุญู ุงูุชููููุงุช ุจููุงูุฉ ูู ุญุตุฉุ ูุฑูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ุงูุตููู ุงูููููุจุฉ ุจุชูุธูู ูุธุงู ูุทุฑ ููุชุนููู."
    elif avg_completion >= 60:
        return "ูุชูุณุท ุงูุฅูุฌุงุฒ ูู ุงููุงุฏุฉ ูุนูุณ ุชูุงุนููุง ููุจูููุง ูุน ุงูุชููููุงุช ุงูุฃุณุจูุนูุฉุ ูููู ุจุญุงุฌุฉ ุฅูู ุฏูุน ุฅุถุงูู. ูููุตู ุจุชุนุฒูุฒ ุงููุชุงุจุนุฉ ูุงูุชูุงุตู ูุน ุฃูููุงุก ุงูุฃููุฑ ูุฑูุน ูุณุชูู ุงูุงูุชุฒุงูุ ูุน ุงูุงุณุชูุฑุงุฑ ูู ุชุฐููุฑ ุงูุทูุงุจ ุฏุงุฆููุง ุจุญู ุงูุชููููุงุช ุจููุงูุฉ ูู ุญุตุฉุ ูุฑูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ุงูุตููู ุงูููููุจุฉ ุจุชูุธูู ูุธุงู ูุทุฑ ููุชุนููู."
    elif avg_completion >= 40:
        return "ูุณุจุฉ ุงูุฅูุฌุงุฒ ูุชูุณุทุฉ ููุฎูุถุฉ ูุชุญุชุงุฌ ุฅูู ุฑูุน. ูููุตู ุจุฒูุงุฏุฉ ุงููุชุงุจุนุฉ ูู ุงููุณู ูุงูุชูุงุตู ูุน ุฃูููุงุก ุงูุฃููุฑ ูุชุญููุฒ ุงูุทูุงุจ ุนูู ุงูุงูุชุฒุงูุ ูุน ุงูุชุดุฏูุฏ ุนูู ุชุฐููุฑ ุงูุทูุงุจ ุฏุงุฆููุง ุจุญู ุงูุชููููุงุช ุจููุงูุฉ ูู ุญุตุฉุ ูุฑูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ุงูุตููู ุงูููููุจุฉ ุจุชูุธูู ูุธุงู ูุทุฑ ููุชุนููู."
    elif avg_completion > 0:
        return "ุงููุงุฏุฉ ุฃุธูุฑุช ุถุนููุง ูู ุฅูุฌุงุฒ ุงูุชููููุงุช ุงูุฃุณุจูุนูุฉ. ูููุตู ุจุชุฏุฎู ูุจุงุดุฑ ูู ุงููุณู ูุน ุชูุนูู ุงูุชูุงุตู ูุน ุฃูููุงุก ุงูุฃููุฑ ุจุดูู ููุชุธู ูุชุนุฒูุฒ ุงูุชุฒุงู ุงูุทูุงุจุ ูุน ุงูุชุฑููุฒ ุนูู ุชุฐููุฑ ุงูุทูุงุจ ุฏุงุฆููุง ุจุญู ุงูุชููููุงุช ุจููุงูุฉ ูู ุญุตุฉุ ูุฑูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ุงูุตููู ุงูููููุจุฉ ุจุชูุธูู ูุธุงู ูุทุฑ ููุชุนููู."
    else:
        return "ูู ูุชู ุชุณุฌูู ุฃู ุฅูุฌุงุฒ ูู ุงูุชููููุงุช ุงูุฃุณุจูุนูุฉ ููุฐู ุงููุงุฏุฉ. ูููุตู ุจูุชุงุจุนุฉ ุนุงุฌูุฉ ูู ุงููุณูุ ูุน ุชูุซูู ุงูุชูุงุตู ูุน ุฃูููุงุก ุงูุฃููุฑ ูุชูุถูุญ ุฃูููุฉ ุงูุงูุชุฒุงู ุจุงููุธุงูุ ูุงูุชุฑููุฒ ุนูู ุชุฐููุฑ ุงูุทูุงุจ ุฏุงุฆููุง ุจุญู ุงูุชููููุงุช ุจููุงูุฉ ูู ุญุตุฉุ ูุฑูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ุงูุตููู ุงูููููุจุฉ ุจุชูุธูู ูุธุงู ูุทุฑ ููุชุนููู."


def to_excel_bytes(sheets: Dict[str,pd.DataFrame]) -> bytes:
    mem = BytesIO()
    with pd.ExcelWriter(mem, engine="openpyxl") as w:
        for name, df in sheets.items():
            df.to_excel(w, sheet_name=name[:31] or "Sheet1", index=False)
    mem.seek(0); return mem.getvalue()

# ---------- Streamlit App (ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ) ----------
def main():
    st.title("๐ ุฃู ุฅูุฌุงุฒ - ููุญุฉ ุชุญููู ุฅูุฌุงุฒ ุงูุทูุงุจ ุงูุฐููุฉ")
    st.markdown("ุฃุฏุงุฉ ุชุญููููุฉ ุชุนุชูุฏ ุนูู ุงูุชุญููู ุงูุฅุญุตุงุฆู ูุงูุชูุตูุงุช ุงูุซุงุจุชุฉ ุงููุฎุตุตุฉ ูุฑูุน ูุณุจุฉ ุงูุฅูุฌุงุฒ ุงูุฃูุงุฏููู.")

    # 1. ุฅุนุฏุงุฏุงุช ุงููุธุงู
    with st.sidebar.expander("โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุธุงู ููุนุงููุฑ ุงูุชุตููู"):
        st.session_state.smtp_configured = st.checkbox("ุชู ุฅุนุฏุงุฏ ุฎุงุฏู SMTP (ูุฅุฑุณุงู ุงูุฅููููุงุช)", value=False)
        inactive_threshold = st.slider("ูุณุจุฉ ุงูุฅูุฌุงุฒ ูุงุนุชุจุงุฑ ุงูุทุงูุจ 'ุบูุฑ ูุงุนู' (%)", 0, 50, 10)
        
        # *****************************************************************
        # ุชุนุฏูู ุงูููู ุงูุงูุชุฑุงุถูุฉ ูุนุชุจุงุช ุงูุชุตููู
        # *****************************************************************
        st.session_state.thresholds = {
            "Platinum": st.number_input("ุญุฏ Platinum (ุฃูุจุฑ ูู)", 0, 100, 89),
            "Gold": st.number_input("ุญุฏ Gold (ุฃูุจุฑ ูู)", 0, 100, 79),
            "Silver": st.number_input("ุญุฏ Silver (ุฃูุจุฑ ูู)", 0, 100, 49),
            "Bronze": st.number_input("ุญุฏ Bronze (ุฃูุจุฑ ูู)", 0, 100, 0) # ุงูุจุฑููุฒู ุงูุจุฑ ูู ุตูุฑ
        }
        # *****************************************************************

    # 2. ุชุญููู ูููุงุช ุงููุนูููู (ูุฑุจุท ุงูุทุงูุจ ุจุงููุนูู)
    teacher_file = st.sidebar.file_uploader("๐ ุชุญููู ููู ุจูุงูุงุช ุงููุนูููู (ูุฅุฑุณุงู ุงูุฅููููุงุช)", type=["xlsx", "csv", "xls"])
    if teacher_file:
        teachers_df = _load_teachers_df(teacher_file)
        st.session_state.teachers_df = teachers_df
        if teachers_df is not None:
            st.sidebar.success(f"ุชู ุชุญููู {len(teachers_df)} ุณุฌู ูุนูู.")
            with st.sidebar.expander("ูุนุงููุฉ ุจูุงูุงุช ุงููุนูููู"):
                st.dataframe(teachers_df, use_container_width=True)
    else:
        st.session_state.teachers_df = None

    # 3. ุชุญููู ูููุงุช ุงูุชููููุงุช
    uploaded_files = st.sidebar.file_uploader("๐ ุชุญููู ูููุงุช ุงูุชููููุงุช (Excel)", type=["xlsx", "xls"], accept_multiple_files=True)
    
    if uploaded_files:
        raw_rows = []
        for file in uploaded_files:
            try:
                xls = pd.ExcelFile(file)
                selected_sheets = st.sidebar.multiselect(f"ุงุฎุชุฑ ุฃูุฑุงู ูู {file.name}", xls.sheet_names, default=xls.sheet_names)
                rows = process_excel_file(file, file.name, start_row_students=1, selected_sheets=selected_sheets)
                raw_rows.extend(rows)
            except Exception as e:
                st.error(f"ูุดู ูุนุงูุฌุฉ ุงูููู {file.name}: {e}")
        
        if raw_rows:
            raw_df = pd.DataFrame(raw_rows)
            st.session_state.raw_df = raw_df
            st.sidebar.success(f"ุชู ุฏูุฌ {len(raw_df)} ุณุฌู ุจูุฌุงุญ.")
            
            # 4. ุจูุงุก ุงูููุฎุต ุงููุญูุฑู
            with st.spinner("ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช ูุจูุงุก ุงูุชูุตูุงุช..."):
                summary_df, subjects = build_summary_pivot(
                    raw_df, 
                    st.session_state.teachers_df, 
                    st.session_state.get("thresholds", {"Platinum": 89, "Gold": 79, "Silver": 49, "Bronze": 0})
                )
            
            st.session_state.summary_df = summary_df
            st.session_state.subjects = subjects
            
            st.header("ูุชุงุฆุฌ ุงูุชุญููู ูุงูุฅูุฌุงุฒ ุงูุนุงู")
            st.dataframe(summary_df, use_container_width=True)
            
            # 5. ุงูุฑุณูู ุงูุจูุงููุฉ (ูุซุงู)
            if not summary_df.empty:
                col1, col2 = st.columns(2)
                with col1:
                    fig = px.histogram(summary_df, x="ุงููุฆุฉ", color="ุงููุฆุฉ", 
                                       title="ุชูุฒูุน ุงูุทูุงุจ ุญุณุจ ูุฆุฉ ุงูุฅูุฌุงุฒ",
                                       category_orders={"ุงููุฆุฉ": ["๐ Platinum", "๐ฅ Gold", "๐ฅ Silver", "๐ฅ Bronze", "๐ง Needs Improvement", "๐ซ Not Utilizing System"]})
                    st.plotly_chart(fig, use_container_width=True)
                
                with col2:
                    fig2 = px.box(summary_df, y="ูุณุจุฉ ุงูุฅูุฌุงุฒ %", color="ุงูุดุนุจุฉ",
                                  title="ุชูุฒูุน ูุณุจ ุงูุฅูุฌุงุฒ ุญุณุจ ุงูุดุนุจุฉ")
                    st.plotly_chart(fig2, use_container_width=True)

            # 6. ุงูุชูุตูุงุช ุนูู ูุณุชูู ุงููุงุฏุฉ (ุงูุซุงุจุชุฉ)
            st.header("ุชุญููู ุงูุฃููุงุท ูุงูุชูุตูุงุช ุนูู ูุณุชูู ุงููุงุฏุฉ")
            for subj in subjects:
                with st.expander(f"โจ ุชุญููู ูุงุฏุฉ: {subj}"):
                    st.markdown(f"**ุงูุชูุตูุฉ ุงูุชุดุบูููุฉ ูููุงุฏุฉ:**")
                    st.info(analyze_subject_patterns(summary_df, subj))
            
            # 7. ุฎูุงุฑุงุช ุงูุชุตุฏูุฑ ูุงูุฅูููู
            st.header("ุฅุฌุฑุงุกุงุช ุฅุถุงููุฉ")
            col_export, col_email = st.columns(2)
            
            with col_export:
                # ุชุตุฏูุฑ Excel
                excel_data = to_excel_bytes({"ููุฎุต ุงูุฅูุฌุงุฒ": summary_df})
                st.download_button(
                    label="โฌ๏ธ ุชุตุฏูุฑ ููุฎุต ุงูุฅูุฌุงุฒ (Excel)",
                    data=excel_data,
                    file_name="ููุฎุต_ุฅูุฌุงุฒ_ุงูุทูุงุจ_ุงููุญุฏุซ.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
            
            with col_email:
                # ุฅุฑุณุงู ุงูุฅููููุงุช
                if st.button("๐ง ุฅุฑุณุงู ุชูุจููุงุช ุงูุทูุงุจ ุบูุฑ ุงููุงุนููู ูููุนูููู"):
                    send_teacher_emails(summary_df, inactive_threshold)
                    st.success("ุชู ุงูุงูุชูุงุก ูู ุนูููุฉ ุชูููุฏ ุงูุชูุจููุงุช.")
        else:
            st.warning("ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ุตุงูุญุฉ ูููุนุงูุฌุฉ.")
    else:
        st.info("ุงูุฑุฌุงุก ุชุญููู ูููุงุช ุงูุชููููุงุช ููุจุฏุก ุจุงูุชุญููู.")

if __name__ == "__main__":
    main()
ุนุฏู ุงูููุฏ - Manus
